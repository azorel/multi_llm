{% extends "base.html" %}

{% block title %}Workflow Templates - LifeOS{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üîÑ Workflow Templates</h1>
    <p class="page-subtitle">
        Automated workflow templates for common tasks and processes in your LifeOS system.
    </p>
</div>

<div class="database-container">
    <div class="database-header">
        <span class="database-title">Workflow Templates ({{ workflows|length if workflows else 0 }} workflows)</span>
        <button class="add-button" onclick="addNewWorkflow()">+ Add Workflow</button>
    </div>
    
    {% if workflows and workflows|length > 0 %}
    <table class="database-table">
        <thead>
            <tr>
                <th style="width: 40px;">‚ñ∂Ô∏è</th>
                <th>Workflow Name</th>
                <th>Description</th>
                <th>Steps</th>
                <th>Triggers</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for workflow in workflows %}
            <tr class="{% if not workflow.enabled %}completed{% endif %}">
                <td>
                    <input type="checkbox" 
                           class="notion-checkbox" 
                           {% if workflow.enabled %}checked{% endif %}
                           data-table="workflow_templates" 
                           data-id="{{ workflow.id }}" 
                           data-field="enabled">
                </td>
                <td style="font-weight: 600;">{{ workflow.workflow_name or 'Unnamed Workflow' }}</td>
                <td style="color: var(--notion-text-light);">{{ (workflow.description or '')[:100] }}{% if workflow.description and workflow.description|length > 100 %}...{% endif %}</td>
                <td style="color: var(--notion-blue); font-size: 12px;">
                    {% if workflow.steps %}
                        {{ workflow.steps.count('\n') + 1 if '\n' in workflow.steps else '1' }} steps
                    {% else %}
                        No steps
                    {% endif %}
                </td>
                <td style="color: var(--notion-text-light); font-size: 12px;">{{ (workflow.triggers or 'Manual')[:30] }}{% if workflow.triggers and workflow.triggers|length > 30 %}...{% endif %}</td>
                <td>
                    {% if workflow.enabled %}
                        <span class="status-pill status-active">üü¢ Active</span>
                    {% else %}
                        <span class="status-pill status-error">‚≠ï Disabled</span>
                    {% endif %}
                </td>
                <td>
                    {% if workflow.enabled %}
                        <button onclick="runWorkflow({{ workflow.id }})" style="background: var(--notion-blue); color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">
                            ‚ñ∂Ô∏è Run
                        </button>
                    {% else %}
                        <span style="color: var(--notion-text-light);">Disabled</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 40px; text-align: center; color: var(--notion-text-light);">
        <p>No workflow templates created yet. Build automated workflows for your common tasks!</p>
    </div>
    {% endif %}
</div>

<!-- Workflow Categories -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 32px;">
    <div class="notion-card">
        <div class="card-title">üìä Workflow Stats</div>
        <div class="card-content">
            {% if workflows and workflows|length > 0 %}
                {% set active = workflows | selectattr('enabled', 'equalto', True) | list %}
                {% set automated = workflows | selectattr('triggers', 'ne', 'Manual') | list %}
                Total Workflows: {{ workflows|length }}<br>
                Active: {{ active|length }}<br>
                Automated: {{ automated|length }}
            {% else %}
                No workflows configured
            {% endif %}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">ü§ñ Automation Types</div>
        <div class="card-content">
            {% if workflows and workflows|length > 0 %}
                {% set scheduled_count = 0 %}
                {% set event_count = 0 %}
                {% set manual_count = 0 %}
                {% for w in workflows %}
                    {% if w.triggers and 'schedule' in w.triggers.lower() %}
                        {% set scheduled_count = scheduled_count + 1 %}
                    {% elif w.triggers and 'event' in w.triggers.lower() %}
                        {% set event_count = event_count + 1 %}
                    {% elif w.triggers and w.triggers.lower() == 'manual' %}
                        {% set manual_count = manual_count + 1 %}
                    {% endif %}
                {% endfor %}
                Scheduled: {{ scheduled_count }}<br>
                Event-driven: {{ event_count }}<br>
                Manual: {{ manual_count }}
            {% else %}
                No automation configured
            {% endif %}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">üéØ Popular Workflows</div>
        <div class="card-content">
            {% if workflows and workflows|length > 0 %}
                Common workflows:<br>
                ‚Ä¢ Morning routine setup<br>
                ‚Ä¢ YouTube processing<br>
                ‚Ä¢ Daily task generation<br>
                ‚Ä¢ RC maintenance checks
            {% else %}
                No workflows to display
            {% endif %}
        </div>
    </div>
</div>

<!-- Workflow Examples -->
<div class="notion-card" style="margin-top: 32px;">
    <div class="card-title">üí° Example Workflow Templates</div>
    <div class="card-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
            <div>
                <strong>Morning Routine:</strong><br>
                1. Check Today's CC<br>
                2. Review calendar events<br>
                3. Update habit tracking<br>
                4. Generate daily tasks<br><br>
                <strong>Content Processing:</strong><br>
                1. Scan marked YouTube channels<br>
                2. Extract and analyze transcripts<br>
                3. Create knowledge hub entries<br>
                4. Update channel status
            </div>
            <div>
                <strong>RC Maintenance Flow:</strong><br>
                1. Check maintenance schedule<br>
                2. Identify overdue items<br>
                3. Create maintenance tasks<br>
                4. Update completion status<br><br>
                <strong>Evening Wrap-up:</strong><br>
                1. Review completed tasks<br>
                2. Update habit streaks<br>
                3. Plan tomorrow's priorities<br>
                4. Generate summary report
            </div>
        </div>
    </div>
</div>

<script>
function addNewWorkflow() {
    const name = prompt('Workflow name:');
    if (name) {
        const description = prompt('Description:');
        const steps = prompt('Steps (separate with newlines):');
        const triggers = prompt('Triggers (schedule, event, manual):', 'manual');
        
        fetch('/add-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table: 'workflow_templates',
                data: {
                    workflow_name: name,
                    description: description || '',
                    steps: steps || '',
                    triggers: triggers || 'manual',
                    enabled: true
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to add workflow template');
            }
        });
    }
}

function runWorkflow(workflowId) {
    if (confirm('Run this workflow? This will execute all steps in the template.')) {
        // In a real implementation, this would trigger the workflow execution
        alert(`Workflow ${workflowId} would be executed here. This is a demo interface.`);
        
        // You could implement actual workflow execution here
        // fetch('/run-workflow', { ... })
    }
}
</script>
{% endblock %}
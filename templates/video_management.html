<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .video-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .video-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .video-thumbnail {
            width: 200px;
            height: 112px;
            object-fit: cover;
        }
        .quality-badge {
            font-size: 0.8em;
        }
        .action-buttons button {
            margin: 2px;
        }
        .marked-delete { border-left: 4px solid #dc3545; }
        .marked-edit { border-left: 4px solid #ffc107; }
        .marked-integration { border-left: 4px solid #28a745; }
        .search-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-video"></i> Video Management System
                </h1>
                
                <!-- Stats Overview -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h5><i class="fas fa-film"></i> Total Videos</h5>
                            <h2 id="total-videos">{{ videos|length }}</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h5><i class="fas fa-trash"></i> Marked for Delete</h5>
                            <h2 id="marked-delete">{{ videos|selectattr('mark_for_delete')|list|length }}</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h5><i class="fas fa-edit"></i> Marked for Edit</h5>
                            <h2 id="marked-edit">{{ videos|selectattr('mark_for_edit')|list|length }}</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h5><i class="fas fa-plus-circle"></i> For Integration</h5>
                            <h2 id="marked-integration">{{ videos|selectattr('mark_for_integration')|list|length }}</h2>
                        </div>
                    </div>
                </div>
                
                <!-- Search and Filters -->
                <div class="search-filters">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="search-input" placeholder="Search videos...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filter-select">
                                <option value="all">All Videos</option>
                                <option value="marked_delete">Marked for Delete</option>
                                <option value="marked_edit">Marked for Edit</option>
                                <option value="marked_integration">For Integration</option>
                                <option value="high_quality">High Quality (>0.7)</option>
                                <option value="auto_check">Auto-Check Enabled</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary" onclick="searchVideos()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        <div class="col-md-3">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-secondary" onclick="selectAll()">Select All</button>
                                <button class="btn btn-outline-secondary" onclick="clearSelection()">Clear</button>
                                <button class="btn btn-danger" onclick="bulkAction('delete_marked')" id="bulk-delete">
                                    <i class="fas fa-trash"></i> Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Video List -->
                <div id="video-list">
                    {% for video in videos %}
                    <div class="video-card {% if video.mark_for_delete %}marked-delete{% elif video.mark_for_edit %}marked-edit{% elif video.mark_for_integration %}marked-integration{% endif %}" data-video-id="{{ video.id }}">
                        <div class="row g-0">
                            <div class="col-md-2">
                                <input type="checkbox" class="video-checkbox m-2" value="{{ video.id }}">
                                {% if video.thumbnail_url %}
                                <img src="{{ video.thumbnail_url }}" class="video-thumbnail" alt="Thumbnail">
                                {% else %}
                                <div class="video-thumbnail bg-secondary d-flex align-items-center justify-content-center">
                                    <i class="fas fa-play-circle fa-3x text-white"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-7">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <a href="/video/{{ video.id }}" class="text-decoration-none">
                                            {{ video.name[:80] }}{% if video.name|length > 80 %}...{% endif %}
                                        </a>
                                    </h5>
                                    <p class="card-text">
                                        <strong>Channel:</strong> {{ video.channel }}<br>
                                        <strong>Duration:</strong> {{ video.duration_formatted }}<br>
                                        <strong>Views:</strong> {{ "{:,}".format(video.view_count) if video.view_count else 'N/A' }}
                                    </p>
                                    <p class="card-text">
                                        <small class="text-muted">{{ video.ai_context[:150] }}{% if video.ai_context|length > 150 %}...{% endif %}</small>
                                    </p>
                                    
                                    <!-- Quality Badges -->
                                    <div class="mb-2">
                                        {% if video.quality_score %}
                                        <span class="badge quality-badge {% if video.quality_score > 0.7 %}bg-success{% elif video.quality_score > 0.5 %}bg-warning{% else %}bg-danger{% endif %}">
                                            Quality: {{ "%.1f"|format(video.quality_score * 100) }}%
                                        </span>
                                        {% endif %}
                                        
                                        {% if video.technical_complexity %}
                                        <span class="badge bg-info quality-badge">
                                            Complexity: {{ video.technical_complexity }}/10
                                        </span>
                                        {% endif %}
                                        
                                        {% if video.auto_check_enabled %}
                                        <span class="badge bg-primary quality-badge">
                                            <i class="fas fa-sync-alt"></i> Auto-Check
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card-body">
                                    <div class="action-buttons">
                                        <!-- Mark Actions -->
                                        <div class="btn-group-vertical d-grid gap-1 mb-2">
                                            <button class="btn btn-sm {% if video.mark_for_delete %}btn-danger{% else %}btn-outline-danger{% endif %}" 
                                                    onclick="markVideo({{ video.id }}, 'delete')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                            <button class="btn btn-sm {% if video.mark_for_edit %}btn-warning{% else %}btn-outline-warning{% endif %}" 
                                                    onclick="markVideo({{ video.id }}, 'edit')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-sm {% if video.mark_for_integration %}btn-success{% else %}btn-outline-success{% endif %}" 
                                                    onclick="markVideo({{ video.id }}, 'integration')">
                                                <i class="fas fa-plus-circle"></i> Integrate
                                            </button>
                                        </div>
                                        
                                        <!-- Auto-check toggle -->
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   {% if video.auto_check_enabled %}checked{% endif %}
                                                   onchange="toggleAutoCheck({{ video.id }}, this.checked)">
                                            <label class="form-check-label small">Auto-Check</label>
                                        </div>
                                        
                                        <!-- View Details -->
                                        <a href="/video/{{ video.id }}" class="btn btn-sm btn-outline-primary mt-1">
                                            <i class="fas fa-eye"></i> Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Video pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item"><a class="page-link" href="#">Previous</a></li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item"><a class="page-link" href="#">Next</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- Integration Modal -->
    <div class="modal fade" id="integrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Integration Workflow</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="integration-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="approveIntegration()">Approve</button>
                    <button type="button" class="btn btn-danger" onclick="rejectIntegration()">Reject</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentVideoId = null;
        
        function markVideo(videoId, action) {
            const data = {
                video_id: videoId,
                action: action,
                notes: prompt(`Notes for ${action}:`) || ''
            };
            
            fetch('/api/mark_video', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    location.reload();
                } else {
                    alert('Action failed');
                }
            });
        }
        
        function toggleAutoCheck(videoId, enabled) {
            const data = {
                video_id: videoId,
                enabled: enabled
            };
            
            fetch('/api/update_auto_check', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    alert('Auto-check update failed');
                    location.reload();
                }
            });
        }
        
        function searchVideos() {
            const query = document.getElementById('search-input').value;
            const filter = document.getElementById('filter-select').value;
            
            fetch(`/api/search_videos?q=${encodeURIComponent(query)}&filter=${filter}`)
            .then(response => response.json())
            .then(videos => {
                updateVideoList(videos);
            });
        }
        
        function updateVideoList(videos) {
            // Update the video list with search results
            // This would replace the current video cards
            console.log('Search results:', videos);
        }
        
        function selectAll() {
            document.querySelectorAll('.video-checkbox').forEach(cb => cb.checked = true);
        }
        
        function clearSelection() {
            document.querySelectorAll('.video-checkbox').forEach(cb => cb.checked = false);
        }
        
        function bulkAction(action) {
            const selectedIds = Array.from(document.querySelectorAll('.video-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                alert('No videos selected');
                return;
            }
            
            if (action === 'delete_marked' && !confirm(`Delete ${selectedIds.length} videos?`)) {
                return;
            }
            
            const data = {
                video_ids: selectedIds,
                action: action
            };
            
            fetch('/api/bulk_action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                location.reload();
            });
        }
        
        function showIntegrationModal(videoId) {
            currentVideoId = videoId;
            // Load integration details
            fetch(`/video/${videoId}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('integration-content').innerHTML = html;
                new bootstrap.Modal(document.getElementById('integrationModal')).show();
            });
        }
        
        function approveIntegration() {
            if (!currentVideoId) return;
            
            const data = {
                video_id: currentVideoId,
                action: 'approve'
            };
            
            fetch('/api/integration_workflow', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                location.reload();
            });
        }
        
        function rejectIntegration() {
            if (!currentVideoId) return;
            
            const reason = prompt('Reason for rejection:');
            if (!reason) return;
            
            const data = {
                video_id: currentVideoId,
                action: 'reject',
                reason: reason
            };
            
            fetch('/api/integration_workflow', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                location.reload();
            });
        }
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            // Refresh stats without full page reload
            fetch('/api/search_videos?filter=all')
            .then(response => response.json())
            .then(videos => {
                // Update stats counters
                console.log('Background refresh complete');
            });
        }, 30000);
    </script>
</body>
</html>
{% extends "base.html" %}

{% block title %}LLM Provider Status - LifeOS{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div class="page-title-container">
            <h1 class="page-title">üîó LLM Provider Status</h1>
            <p class="page-description">Monitor health and performance of multiple language model providers</p>
        </div>
        <div class="page-actions">
            <button onclick="refreshStatus()" class="btn-primary">üîÑ Refresh</button>
            <button onclick="showRebalanceModal()" class="btn-secondary">‚öñÔ∏è Rebalance</button>
        </div>
    </div>

    <!-- Overall Health Status -->
    <div class="status-overview">
        <div class="health-card" id="overall-health">
            <div class="health-icon">‚ö°</div>
            <div class="health-info">
                <h3>System Health</h3>
                <div class="health-score" id="health-score">Loading...</div>
                <div class="health-status" id="health-status">Checking...</div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-requests">-</div>
                <div class="stat-label">Total Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-cost">-</div>
                <div class="stat-label">Total Cost</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-agents">-</div>
                <div class="stat-label">Active Agents</div>
            </div>
        </div>
    </div>

    <!-- Provider Details -->
    <div class="providers-grid">
        <!-- Anthropic Claude -->
        <div class="provider-card" data-provider="anthropic">
            <div class="provider-header">
                <div class="provider-logo">üîÆ</div>
                <div class="provider-info">
                    <h3>Anthropic Claude</h3>
                    <div class="provider-status" id="claude-status">Checking...</div>
                </div>
                <div class="provider-indicator" id="claude-indicator"></div>
            </div>
            <div class="provider-stats">
                <div class="stat-row">
                    <span>Requests:</span>
                    <span id="claude-requests">-</span>
                </div>
                <div class="stat-row">
                    <span>Success Rate:</span>
                    <span id="claude-success">-</span>
                </div>
                <div class="stat-row">
                    <span>Avg Response:</span>
                    <span id="claude-response-time">-</span>
                </div>
                <div class="stat-row">
                    <span>Cost:</span>
                    <span id="claude-cost">-</span>
                </div>
                <div class="stat-row">
                    <span>Weight:</span>
                    <span id="claude-weight">-</span>
                </div>
            </div>
        </div>

        <!-- OpenAI GPT -->
        <div class="provider-card" data-provider="openai">
            <div class="provider-header">
                <div class="provider-logo">ü§ñ</div>
                <div class="provider-info">
                    <h3>OpenAI GPT</h3>
                    <div class="provider-status" id="openai-status">Checking...</div>
                </div>
                <div class="provider-indicator" id="openai-indicator"></div>
            </div>
            <div class="provider-stats">
                <div class="stat-row">
                    <span>Requests:</span>
                    <span id="openai-requests">-</span>
                </div>
                <div class="stat-row">
                    <span>Success Rate:</span>
                    <span id="openai-success">-</span>
                </div>
                <div class="stat-row">
                    <span>Avg Response:</span>
                    <span id="openai-response-time">-</span>
                </div>
                <div class="stat-row">
                    <span>Cost:</span>
                    <span id="openai-cost">-</span>
                </div>
                <div class="stat-row">
                    <span>Weight:</span>
                    <span id="openai-weight">-</span>
                </div>
            </div>
        </div>

        <!-- Google Gemini -->
        <div class="provider-card" data-provider="gemini">
            <div class="provider-header">
                <div class="provider-logo">üíé</div>
                <div class="provider-info">
                    <h3>Google Gemini</h3>
                    <div class="provider-status" id="gemini-status">Checking...</div>
                </div>
                <div class="provider-indicator" id="gemini-indicator"></div>
            </div>
            <div class="provider-stats">
                <div class="stat-row">
                    <span>Requests:</span>
                    <span id="gemini-requests">-</span>
                </div>
                <div class="stat-row">
                    <span>Success Rate:</span>
                    <span id="gemini-success">-</span>
                </div>
                <div class="stat-row">
                    <span>Avg Response:</span>
                    <span id="gemini-response-time">-</span>
                </div>
                <div class="stat-row">
                    <span>Cost:</span>
                    <span id="gemini-cost">-</span>
                </div>
                <div class="stat-row">
                    <span>Weight:</span>
                    <span id="gemini-weight">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Distribution -->
    <div class="section-card">
        <h3>ü§ñ Agent Distribution</h3>
        <div class="agent-distribution" id="agent-distribution">
            <div class="loading">Loading agent distribution...</div>
        </div>
    </div>

    <!-- Performance Chart -->
    <div class="section-card">
        <h3>üìä Performance Trends</h3>
        <div class="chart-container">
            <canvas id="performance-chart" width="800" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Rebalance Modal -->
<div id="rebalance-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚öñÔ∏è Rebalance Providers</h3>
            <span class="close" onclick="closeRebalanceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="weight-controls">
                <div class="weight-control">
                    <label>Anthropic Claude Weight:</label>
                    <input type="range" id="claude-weight-slider" min="0" max="1" step="0.1" value="0.3">
                    <span id="claude-weight-value">0.3</span>
                </div>
                <div class="weight-control">
                    <label>OpenAI GPT Weight:</label>
                    <input type="range" id="openai-weight-slider" min="0" max="1" step="0.1" value="0.4">
                    <span id="openai-weight-value">0.4</span>
                </div>
                <div class="weight-control">
                    <label>Google Gemini Weight:</label>
                    <input type="range" id="gemini-weight-slider" min="0" max="1" step="0.1" value="0.3">
                    <span id="gemini-weight-value">0.3</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="applyRebalance()" class="btn-primary">Apply Changes</button>
            <button onclick="closeRebalanceModal()" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<style>
.page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e0e0e0;
}

.page-title {
    font-size: 28px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
}

.page-description {
    color: #666;
    margin: 5px 0 0 0;
}

.page-actions {
    display: flex;
    gap: 10px;
}

.btn-primary, .btn-secondary {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.2s;
}

.btn-primary {
    background-color: #007acc;
    color: white;
}

.btn-primary:hover {
    background-color: #005fa3;
}

.btn-secondary {
    background-color: #f0f0f0;
    color: #333;
}

.btn-secondary:hover {
    background-color: #e0e0e0;
}

.status-overview {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.health-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 20px;
    color: white;
    display: flex;
    align-items: center;
    gap: 15px;
}

.health-icon {
    font-size: 32px;
}

.health-info h3 {
    margin: 0 0 5px 0;
    font-size: 16px;
    opacity: 0.9;
}

.health-score {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 5px;
}

.health-status {
    font-size: 14px;
    opacity: 0.8;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

.stat-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 600;
    color: #007acc;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    color: #666;
}

.providers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.provider-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
    transition: box-shadow 0.2s;
}

.provider-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.provider-header {
    display: flex;
    align-items: center;
    padding: 20px;
    background: #f8f9fa;
    gap: 15px;
}

.provider-logo {
    font-size: 24px;
}

.provider-info h3 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #1a1a1a;
}

.provider-status {
    font-size: 14px;
    color: #666;
}

.provider-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: auto;
}

.provider-indicator.healthy {
    background-color: #4caf50;
}

.provider-indicator.warning {
    background-color: #ff9800;
}

.provider-indicator.error {
    background-color: #f44336;
}

.provider-stats {
    padding: 20px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.stat-row:last-child {
    border-bottom: none;
}

.section-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.section-card h3 {
    margin: 0 0 15px 0;
    color: #1a1a1a;
}

.agent-distribution {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.agent-type {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.agent-count {
    font-size: 24px;
    font-weight: 600;
    color: #007acc;
}

.agent-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.chart-container {
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 0;
    border-radius: 12px;
    width: 500px;
    max-width: 90%;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.modal-header h3 {
    margin: 0;
}

.close {
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.modal-body {
    padding: 20px;
}

.weight-controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.weight-control {
    display: flex;
    align-items: center;
    gap: 15px;
}

.weight-control label {
    flex: 1;
    font-weight: 500;
}

.weight-control input[type="range"] {
    flex: 2;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.loading {
    text-align: center;
    color: #666;
    font-style: italic;
}
</style>

<script>
let statusInterval;

document.addEventListener('DOMContentLoaded', function() {
    loadProviderStatus();
    startAutoRefresh();
    setupWeightSliders();
});

function loadProviderStatus() {
    fetch('/api/providers/status')
        .then(response => response.json())
        .then(data => {
            updateStatusDisplay(data);
        })
        .catch(error => {
            console.error('Error loading provider status:', error);
        });
}

function updateStatusDisplay(data) {
    // Update overall health
    const healthScore = data.overall_health?.score || 0;
    const healthStatus = data.overall_health?.status || 'unknown';
    
    document.getElementById('health-score').textContent = `${healthScore.toFixed(0)}%`;
    document.getElementById('health-status').textContent = healthStatus.toUpperCase();
    
    const healthCard = document.getElementById('overall-health');
    healthCard.className = `health-card ${healthStatus}`;
    
    // Update load balancer stats
    const lbStats = data.load_balancer || {};
    document.getElementById('total-requests').textContent = lbStats.total_requests || 0;
    document.getElementById('total-cost').textContent = `$${(lbStats.total_cost || 0).toFixed(4)}`;
    document.getElementById('active-agents').textContent = data.agents_with_multi_provider || 0;
    
    // Update individual providers
    const providers = lbStats.providers || {};
    updateProviderCard('claude', 'anthropic', providers.anthropic || {}, data.available_providers?.anthropic);
    updateProviderCard('openai', 'gpt', providers.gpt || {}, data.available_providers?.openai);
    updateProviderCard('gemini', 'gemini', providers.gemini || {}, data.available_providers?.gemini);
    
    // Update agent distribution
    updateAgentDistribution(data);
}

function updateProviderCard(prefix, providerKey, stats, available) {
    const requests = stats.requests || 0;
    const errors = stats.errors || 0;
    const successRate = requests > 0 ? ((requests - errors) / requests * 100) : 100;
    
    document.getElementById(`${prefix}-requests`).textContent = requests;
    document.getElementById(`${prefix}-success`).textContent = `${successRate.toFixed(1)}%`;
    document.getElementById(`${prefix}-response-time`).textContent = `${(stats.avg_response_time || 0).toFixed(2)}s`;
    document.getElementById(`${prefix}-cost`).textContent = `$${(stats.cost || 0).toFixed(4)}`;
    document.getElementById(`${prefix}-weight`).textContent = `${(stats.weight || 0).toFixed(1)}`;
    
    // Update status and indicator
    const statusElement = document.getElementById(`${prefix}-status`);
    const indicatorElement = document.getElementById(`${prefix}-indicator`);
    
    if (available) {
        statusElement.textContent = 'Available';
        indicatorElement.className = `provider-indicator ${successRate >= 80 ? 'healthy' : successRate >= 60 ? 'warning' : 'error'}`;
    } else {
        statusElement.textContent = 'Unavailable';
        indicatorElement.className = 'provider-indicator error';
    }
}

function updateAgentDistribution(data) {
    const distributionDiv = document.getElementById('agent-distribution');
    distributionDiv.innerHTML = '';
    
    const lbStats = data.load_balancer || {};
    const providers = lbStats.providers || {};
    
    Object.entries(providers).forEach(([provider, stats]) => {
        const div = document.createElement('div');
        div.className = 'agent-type';
        div.innerHTML = `
            <div class="agent-count">${stats.requests || 0}</div>
            <div class="agent-label">${provider.toUpperCase()} Requests</div>
        `;
        distributionDiv.appendChild(div);
    });
}

function refreshStatus() {
    loadProviderStatus();
}

function startAutoRefresh() {
    statusInterval = setInterval(loadProviderStatus, 30000); // Refresh every 30 seconds
}

function stopAutoRefresh() {
    if (statusInterval) {
        clearInterval(statusInterval);
    }
}

function showRebalanceModal() {
    document.getElementById('rebalance-modal').style.display = 'block';
}

function closeRebalanceModal() {
    document.getElementById('rebalance-modal').style.display = 'none';
}

function setupWeightSliders() {
    const sliders = ['claude', 'openai', 'gemini'];
    
    sliders.forEach(provider => {
        const slider = document.getElementById(`${provider}-weight-slider`);
        const value = document.getElementById(`${provider}-weight-value`);
        
        slider.addEventListener('input', function() {
            value.textContent = this.value;
        });
    });
}

function applyRebalance() {
    const weights = {
        anthropic: parseFloat(document.getElementById('claude-weight-slider').value),
        gpt: parseFloat(document.getElementById('openai-weight-slider').value),
        gemini: parseFloat(document.getElementById('gemini-weight-slider').value)
    };
    
    fetch('/api/providers/rebalance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ weights })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeRebalanceModal();
            loadProviderStatus();
            alert('Provider weights updated successfully!');
        } else {
            alert('Error updating weights: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error updating weights: ' + error.message);
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('rebalance-modal');
    if (event.target === modal) {
        closeRebalanceModal();
    }
}

// Clean up on page unload
window.addEventListener('beforeunload', stopAutoRefresh);
</script>
{% endblock %}
{% extends "sql_base.html" %}

{% block title %}System Health Monitor{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">🔍 System Health Monitor</h1>
    <p class="page-subtitle">
        Real-time system monitoring and health diagnostics for the multi-agent SQL system.
        <span style="float: right; color: var(--notion-text-light); font-size: 12px;">
            Status: <span id="systemHealthStatus">Loading...</span>
            <button onclick="refreshHealth()" style="margin-left: 8px; background: var(--notion-blue); color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 11px; cursor: pointer;">
                🔄 Refresh
            </button>
        </span>
    </p>
</div>

<!-- Health Status Overview -->
<div id="healthOverview" class="notion-card" style="margin-bottom: 24px;">
    <div class="card-title">📊 System Health Overview</div>
    <div class="card-content">
        <div id="healthContent">Loading health data...</div>
    </div>
</div>

<!-- System Metrics -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
    <div class="notion-card">
        <div class="card-title">💻 CPU Usage</div>
        <div class="card-content">
            <div id="cpuUsage" style="font-size: 32px; font-weight: 600; color: var(--notion-blue);">--</div>
            <div style="font-size: 12px; color: var(--notion-text-light);">Percentage</div>
            <div style="margin-top: 8px; background: #f0f0f0; height: 8px; border-radius: 4px;">
                <div id="cpuBar" style="background: var(--notion-blue); height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">🧠 Memory Usage</div>
        <div class="card-content">
            <div id="memoryUsage" style="font-size: 32px; font-weight: 600; color: var(--notion-green);">--</div>
            <div style="font-size: 12px; color: var(--notion-text-light);">Percentage</div>
            <div style="margin-top: 8px; background: #f0f0f0; height: 8px; border-radius: 4px;">
                <div id="memoryBar" style="background: var(--notion-green); height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">💾 Disk Usage</div>
        <div class="card-content">
            <div id="diskUsage" style="font-size: 32px; font-weight: 600; color: var(--notion-orange);">--</div>
            <div style="font-size: 12px; color: var(--notion-text-light);">Percentage</div>
            <div style="margin-top: 8px; background: #f0f0f0; height: 8px; border-radius: 4px;">
                <div id="diskBar" style="background: var(--notion-orange); height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">🗄️ Database</div>
        <div class="card-content">
            <div id="dbSize" style="font-size: 32px; font-weight: 600; color: var(--notion-purple);">--</div>
            <div style="font-size: 12px; color: var(--notion-text-light);">MB</div>
            <div style="margin-top: 4px; font-size: 11px; color: var(--notion-text-light);">
                <span id="dbVideos">-- videos</span>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Panel -->
<div id="alertsPanel" class="notion-card" style="margin-bottom: 32px; display: none;">
    <div class="card-title">⚠️ System Alerts</div>
    <div class="card-content">
        <div id="alertsList"></div>
    </div>
</div>

<!-- Processing Statistics -->
<div class="database-container">
    <div class="database-header">
        <span class="database-title">📈 Processing Statistics</span>
    </div>
    
    <table class="database-table">
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
                <th>Status</th>
                <th>Trend</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="font-weight: 600;">Total Videos</td>
                <td id="statTotalVideos">--</td>
                <td><span class="status-pill status-info">📊 Count</span></td>
                <td>--</td>
            </tr>
            <tr>
                <td style="font-weight: 600;">Processed Videos</td>
                <td id="statProcessedVideos">--</td>
                <td><span class="status-pill status-processed">✅ Complete</span></td>
                <td>--</td>
            </tr>
            <tr>
                <td style="font-weight: 600;">Pending Videos</td>
                <td id="statPendingVideos">--</td>
                <td><span class="status-pill status-pending">⏳ Queue</span></td>
                <td>--</td>
            </tr>
            <tr>
                <td style="font-weight: 600;">Error Videos</td>
                <td id="statErrorVideos">--</td>
                <td><span class="status-pill status-error">❌ Failed</span></td>
                <td>--</td>
            </tr>
            <tr>
                <td style="font-weight: 600;">Processing Rate</td>
                <td id="statProcessingRate">--%</td>
                <td><span class="status-pill status-rate">📊 Rate</span></td>
                <td>--</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Real-time Charts -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 32px;">
    <div class="notion-card">
        <div class="card-title">📊 Resource Usage History</div>
        <div class="card-content">
            <canvas id="resourceChart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">🎯 Processing Progress</div>
        <div class="card-content">
            <div style="text-align: center; padding: 20px;">
                <div style="position: relative; display: inline-block;">
                    <canvas id="progressChart" width="150" height="150"></canvas>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div id="progressPercentage" style="font-size: 24px; font-weight: 600;">--%</div>
                        <div style="font-size: 12px; color: var(--notion-text-light);">Complete</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let healthData = null;
let resourceHistory = {
    cpu: [],
    memory: [],
    disk: [],
    timestamps: []
};

function refreshHealth() {
    fetch('/api/health')
        .then(response => response.json())
        .then(data => {
            healthData = data;
            updateHealthDisplay();
            updateMetrics();
            updateAlerts();
            updateStats();
            updateCharts();
        })
        .catch(error => {
            console.error('Health check failed:', error);
            document.getElementById('systemHealthStatus').textContent = 'ERROR';
            document.getElementById('systemHealthStatus').style.color = '#ef4444';
        });
}

function updateHealthDisplay() {
    const status = healthData.status;
    const statusElement = document.getElementById('systemHealthStatus');
    const healthContent = document.getElementById('healthContent');
    
    statusElement.textContent = status.toUpperCase();
    statusElement.style.color = status === 'healthy' ? '#22c55e' : status === 'warning' ? '#f59e0b' : '#ef4444';
    
    healthContent.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div>
                <div style="font-size: 14px; opacity: 0.8;">System Status</div>
                <div style="font-size: 18px; font-weight: 600; color: ${statusElement.style.color};">${status.toUpperCase()}</div>
            </div>
            <div>
                <div style="font-size: 14px; opacity: 0.8;">Agents Running</div>
                <div style="font-size: 18px; font-weight: 600;">${healthData.system.agents_running ? 'YES' : 'NO'}</div>
            </div>
            <div>
                <div style="font-size: 14px; opacity: 0.8;">Last Check</div>
                <div style="font-size: 18px; font-weight: 600;">${new Date(healthData.timestamp * 1000).toLocaleTimeString()}</div>
            </div>
            <div>
                <div style="font-size: 14px; opacity: 0.8;">Alerts</div>
                <div style="font-size: 18px; font-weight: 600;">${healthData.alerts.length}</div>
            </div>
        </div>
    `;
}

function updateMetrics() {
    const system = healthData.system;
    
    // CPU
    document.getElementById('cpuUsage').textContent = system.cpu_percent + '%';
    document.getElementById('cpuBar').style.width = system.cpu_percent + '%';
    document.getElementById('cpuBar').style.background = system.cpu_percent > 80 ? '#ef4444' : system.cpu_percent > 60 ? '#f59e0b' : '#22c55e';
    
    // Memory
    document.getElementById('memoryUsage').textContent = system.memory_percent + '%';
    document.getElementById('memoryBar').style.width = system.memory_percent + '%';
    document.getElementById('memoryBar').style.background = system.memory_percent > 85 ? '#ef4444' : system.memory_percent > 70 ? '#f59e0b' : '#22c55e';
    
    // Disk
    document.getElementById('diskUsage').textContent = system.disk_percent + '%';
    document.getElementById('diskBar').style.width = system.disk_percent + '%';
    document.getElementById('diskBar').style.background = system.disk_percent > 90 ? '#ef4444' : system.disk_percent > 80 ? '#f59e0b' : '#22c55e';
    
    // Database
    document.getElementById('dbSize').textContent = healthData.database.size_mb;
    document.getElementById('dbVideos').textContent = healthData.database.total_videos + ' videos';
    
    // Update history
    const now = new Date().toLocaleTimeString();
    resourceHistory.cpu.push(system.cpu_percent);
    resourceHistory.memory.push(system.memory_percent);
    resourceHistory.disk.push(system.disk_percent);
    resourceHistory.timestamps.push(now);
    
    // Keep only last 20 data points
    if (resourceHistory.cpu.length > 20) {
        resourceHistory.cpu.shift();
        resourceHistory.memory.shift();
        resourceHistory.disk.shift();
        resourceHistory.timestamps.shift();
    }
}

function updateAlerts() {
    const alertsPanel = document.getElementById('alertsPanel');
    const alertsList = document.getElementById('alertsList');
    
    if (healthData.alerts.length > 0) {
        alertsPanel.style.display = 'block';
        alertsList.innerHTML = healthData.alerts.map(alert => {
            const color = alert.level === 'critical' ? '#ef4444' : alert.level === 'warning' ? '#f59e0b' : '#3b82f6';
            const icon = alert.level === 'critical' ? '🚨' : alert.level === 'warning' ? '⚠️' : 'ℹ️';
            return `<div style="padding: 8px; margin-bottom: 8px; background: ${color}20; border-left: 3px solid ${color}; border-radius: 4px;">
                ${icon} ${alert.message}
            </div>`;
        }).join('');
    } else {
        alertsPanel.style.display = 'none';
    }
}

function updateStats() {
    const db = healthData.database;
    
    document.getElementById('statTotalVideos').textContent = db.total_videos;
    document.getElementById('statProcessedVideos').textContent = db.processed_videos;
    document.getElementById('statPendingVideos').textContent = db.pending_videos;
    document.getElementById('statErrorVideos').textContent = db.error_videos;
    document.getElementById('statProcessingRate').textContent = db.processing_rate + '%';
}

function updateCharts() {
    // Update progress chart
    const processedPercent = healthData.database.processing_rate;
    document.getElementById('progressPercentage').textContent = processedPercent + '%';
    
    // Simple canvas drawing for progress
    const canvas = document.getElementById('progressChart');
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 60;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Background circle
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.strokeStyle = '#e5e7eb';
    ctx.lineWidth = 8;
    ctx.stroke();
    
    // Progress arc
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, -Math.PI / 2, (-Math.PI / 2) + (2 * Math.PI * processedPercent / 100));
    ctx.strokeStyle = '#22c55e';
    ctx.lineWidth = 8;
    ctx.stroke();
}

// Auto-refresh every 5 seconds
setInterval(refreshHealth, 5000);

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    refreshHealth();
});
</script>

<style>
.status-info {
    background: #dbeafe;
    color: #1e40af;
}

.status-rate {
    background: #f3e8ff;
    color: #7c3aed;
}
</style>
{% endblock %}
{% extends "base_modern.html" %}

{% block title %}Business Revenue - LifeOS{% endblock %}
{% block header_title %}Business Revenue{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">💰 Business Revenue</h1>
    <p class="page-subtitle">Track revenue streams, financial performance, and business metrics</p>
    <button class="btn btn-primary" onclick="showAddRevenueModal()">
        ➕ Add Revenue Entry
    </button>
</div>

<!-- Revenue Overview -->
<div class="grid grid-cols-4 gap-6 mb-8">
    <div class="stat-card">
        <div class="stat-value">${{ total_revenue|default(0) }}</div>
        <div class="stat-label">Total Revenue</div>
        <div class="stat-change">{{ revenue_change|default(0) }}% from last month</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">${{ monthly_recurring|default(0) }}</div>
        <div class="stat-label">Monthly Recurring</div>
        <div class="stat-change">{{ mrr_change|default(0) }}% MRR growth</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ active_customers|default(0) }}</div>
        <div class="stat-label">Active Customers</div>
        <div class="stat-change">{{ customer_change|default(0) }}% growth</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">${{ avg_revenue_per_customer|default(0) }}</div>
        <div class="stat-label">Avg Revenue/Customer</div>
        <div class="stat-change">{{ arpu_change|default(0) }}% ARPU change</div>
    </div>
</div>

<!-- Revenue Charts -->
<div class="grid grid-cols-2 gap-6 mb-8">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">📈 Monthly Revenue Trend</h3>
        </div>
        <div class="card-content">
            <div class="space-y-3">
                {% for month in monthly_revenue|default([]) %}
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">{{ month.month|default('Unknown') }}</span>
                    <div class="flex items-center space-x-3">
                        <div class="w-32 bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: {{ (month.revenue / max_monthly_revenue * 100)|default(0) }}%"></div>
                        </div>
                        <span class="text-sm font-medium">${{ month.revenue|default(0) }}</span>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-4">No revenue data available</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">🔍 Revenue Sources</h3>
        </div>
        <div class="card-content">
            <div class="space-y-3">
                {% for source in revenue_sources|default([]) %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: {{ source.color|default('#3B82F6') }}"></div>
                        <span class="text-sm text-gray-700">{{ source.name|default('Unknown Source') }}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium">${{ source.amount|default(0) }}</div>
                        <div class="text-xs text-gray-500">{{ source.percentage|default(0) }}%</div>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-4">No revenue source data</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Revenue Entries -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Revenue Entries</h3>
        <div class="flex gap-2">
            <input type="text" 
                   placeholder="Search entries..." 
                   class="form-input"
                   id="searchRevenue"
                   style="width: 200px;">
            <select class="form-input" id="filterSource" style="width: 150px;">
                <option value="">All Sources</option>
                <option value="subscription">Subscription</option>
                <option value="one_time">One-time</option>
                <option value="consulting">Consulting</option>
                <option value="affiliate">Affiliate</option>
                <option value="other">Other</option>
            </select>
            <input type="month" class="form-input" id="filterMonth" style="width: 150px;">
        </div>
    </div>
    <div class="card-content">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Source</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in revenue_entries|default([]) %}
                    <tr class="revenue-row">
                        <td class="text-sm">
                            {{ entry.date|default('Unknown date') }}
                        </td>
                        <td>
                            <span class="badge badge-info">
                                {% if entry.source == 'subscription' %}🔄{% elif entry.source == 'one_time' %}💳{% elif entry.source == 'consulting' %}💼{% elif entry.source == 'affiliate' %}🤝{% else %}📦{% endif %}
                                {{ entry.source|default('other')|replace('_', ' ')|title }}
                            </span>
                        </td>
                        <td class="text-sm">
                            {{ entry.customer_name|default('Unknown Customer') }}
                        </td>
                        <td class="text-sm font-medium text-green-600">
                            ${{ entry.amount|default(0) }}
                        </td>
                        <td>
                            <span class="badge badge-{% if entry.type == 'recurring' %}success{% else %}secondary{% endif %}">
                                {{ entry.type|default('one_time')|replace('_', ' ')|title }}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-{% if entry.status == 'paid' %}success{% elif entry.status == 'pending' %}warning{% else %}danger{% endif %}">
                                {% if entry.status == 'paid' %}✅{% elif entry.status == 'pending' %}⏳{% else %}❌{% endif %}
                                {{ entry.status|default('pending')|title }}
                            </span>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="viewRevenue({{ entry.id }})">
                                    👁️ View
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="editRevenue({{ entry.id }})">
                                    ✏️ Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteRevenue({{ entry.id }})">
                                    🗑️ Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-12 text-gray-500">
                            <div class="text-6xl mb-4">💰</div>
                            <h3 class="text-lg font-medium mb-2">No revenue entries yet</h3>
                            <p class="text-sm mb-4">Add your first revenue entry to start tracking</p>
                            <button class="btn btn-primary" onclick="showAddRevenueModal()">
                                ➕ Add First Entry
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Revenue Modal -->
<div id="addRevenueModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add Revenue Entry</h3>
            <button class="modal-close" onclick="closeAddRevenueModal()">✕</button>
        </div>
        <div class="modal-body">
            <form id="addRevenueForm">
                <div class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="revenueDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer Name</label>
                        <input type="text" id="customerName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount ($)</label>
                        <input type="number" id="revenueAmount" step="0.01" min="0" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select id="revenueSource" class="form-input" required>
                            <option value="">Select source</option>
                            <option value="subscription">🔄 Subscription</option>
                            <option value="one_time">💳 One-time Purchase</option>
                            <option value="consulting">💼 Consulting</option>
                            <option value="affiliate">🤝 Affiliate</option>
                            <option value="other">📦 Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select id="revenueType" class="form-input">
                            <option value="one_time">One-time</option>
                            <option value="recurring">Recurring</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="revenueStatus" class="form-input">
                            <option value="paid">✅ Paid</option>
                            <option value="pending">⏳ Pending</option>
                            <option value="failed">❌ Failed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="revenueDescription" rows="2" class="form-input"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closeAddRevenueModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary flex-1">
                        Add Entry
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.space-y-3 > * + * {
    margin-top: 0.75rem;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: var(--radius-lg);
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-6);
    border-bottom: 1px solid var(--color-gray-200);
}

.modal-close {
    background: none;
    border: none;
    font-size: var(--font-size-xl);
    cursor: pointer;
    color: var(--text-tertiary);
}

.modal-body {
    padding: var(--space-6);
}

.stat-change {
    font-size: var(--font-size-sm);
    color: var(--text-tertiary);
    margin-top: 0.25rem;
}
</style>

<script>
function showAddRevenueModal() {
    document.getElementById('addRevenueModal').style.display = 'flex';
    // Set today's date as default
    document.getElementById('revenueDate').value = new Date().toISOString().split('T')[0];
}

function closeAddRevenueModal() {
    document.getElementById('addRevenueModal').style.display = 'none';
    document.getElementById('addRevenueForm').reset();
}

document.getElementById('addRevenueForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const data = {
        date: document.getElementById('revenueDate').value,
        customer_name: document.getElementById('customerName').value,
        amount: parseFloat(document.getElementById('revenueAmount').value),
        source: document.getElementById('revenueSource').value,
        type: document.getElementById('revenueType').value,
        status: document.getElementById('revenueStatus').value,
        description: document.getElementById('revenueDescription').value,
        created_at: new Date().toISOString()
    };
    
    fetch('/add-item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            table: 'revenue_entries',
            data: data
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeAddRevenueModal();
            location.reload();
        } else {
            alert('Failed to add revenue entry');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding revenue entry');
    });
});

function viewRevenue(entryId) {
    alert('Revenue details view would be implemented here');
}

function editRevenue(entryId) {
    alert('Edit revenue entry would be implemented here');
}

function deleteRevenue(entryId) {
    if (confirm('Are you sure you want to delete this revenue entry?')) {
        fetch('/delete-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table: 'revenue_entries',
                id: entryId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete revenue entry');
            }
        });
    }
}

// Search and filter functionality
document.getElementById('searchRevenue').addEventListener('input', filterRevenue);
document.getElementById('filterSource').addEventListener('change', filterRevenue);
document.getElementById('filterMonth').addEventListener('change', filterRevenue);

function filterRevenue() {
    const searchTerm = document.getElementById('searchRevenue').value.toLowerCase();
    const sourceFilter = document.getElementById('filterSource').value;
    const monthFilter = document.getElementById('filterMonth').value;
    const rows = document.querySelectorAll('.revenue-row');
    
    rows.forEach(row => {
        const customer = row.cells[2].textContent.toLowerCase();
        const source = row.cells[1].textContent.toLowerCase();
        const date = row.cells[0].textContent;
        
        const matchesSearch = customer.includes(searchTerm);
        const matchesSource = !sourceFilter || source.includes(sourceFilter.replace('_', ' '));
        const matchesMonth = !monthFilter || date.includes(monthFilter);
        
        row.style.display = (matchesSearch && matchesSource && matchesMonth) ? '' : 'none';
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addRevenueModal');
    if (event.target === modal) {
        closeAddRevenueModal();
    }
}
</script>
{% endblock %}
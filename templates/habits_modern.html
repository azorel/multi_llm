{% extends "base_modern.html" %}

{% block title %}Habits - LifeOS{% endblock %}
{% block header_title %}Habits{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üéØ Habit Tracker</h1>
    <p class="page-subtitle">Build better habits and track your progress over time</p>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-4 mb-8">
    <div class="stat-card">
        <div class="stat-value">{{ habits|length or 0 }}</div>
        <div class="stat-label">Total Habits</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ habits|selectattr('is_active')|list|length or 0 }}</div>
        <div class="stat-label">Active Habits</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ habits|sum(attribute='current_streak')|default(0) }}</div>
        <div class="stat-label">Total Streaks</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ habits|map(attribute='completion_rate')|list|sum/habits|length if habits else 0 }}%</div>
        <div class="stat-label">Avg Completion</div>
    </div>
</div>

<!-- Add Habit Card -->
<div class="card mb-8">
    <div class="card-header">
        <h3 class="card-title">‚ûï Add New Habit</h3>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="form-group">
                <label class="form-label">Habit Name</label>
                <input type="text" 
                       class="form-input" 
                       id="newHabitName" 
                       placeholder="Enter habit name">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select id="newHabitCategory" class="form-input">
                    <option value="">Select category...</option>
                    <option value="health">Health & Fitness</option>
                    <option value="productivity">Productivity</option>
                    <option value="learning">Learning</option>
                    <option value="mindfulness">Mindfulness</option>
                    <option value="social">Social</option>
                    <option value="creative">Creative</option>
                    <option value="finance">Finance</option>
                    <option value="personal">Personal</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Frequency</label>
                <select id="newHabitFrequency" class="form-input">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="workdays">Workdays Only</option>
                    <option value="weekends">Weekends Only</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
        </div>
        <div class="grid grid-cols-4 gap-4 mb-4">
            <div class="form-group">
                <label class="form-label">Target (times per period)</label>
                <input type="number" 
                       class="form-input" 
                       id="newHabitTarget" 
                       placeholder="1" 
                       value="1" 
                       min="1">
            </div>
            <div class="form-group">
                <label class="form-label">Duration (minutes)</label>
                <input type="number" 
                       class="form-input" 
                       id="newHabitDuration" 
                       placeholder="Optional" 
                       min="1">
            </div>
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select id="newHabitPriority" class="form-input">
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" 
                       class="form-input" 
                       id="newHabitStartDate" 
                       value="{{ today }}">
            </div>
        </div>
        <div class="form-group mb-4">
            <label class="form-label">Description / Notes</label>
            <textarea class="form-input" 
                      id="newHabitDescription" 
                      rows="2" 
                      placeholder="Why is this habit important? Any specific notes..."></textarea>
        </div>
        <div class="grid grid-cols-4 gap-4">
            <div class="form-group">
                <label class="form-label">Reminder Time</label>
                <input type="time" 
                       class="form-input" 
                       id="newHabitReminderTime">
            </div>
            <div class="form-group">
                <label class="form-label">&nbsp;</label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="newHabitActive" class="form-checkbox" checked>
                    <span class="text-sm">Start active</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">&nbsp;</label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="newHabitPublic" class="form-checkbox">
                    <span class="text-sm">Public tracking</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary w-full" onclick="addHabit()">
                    <span id="addBtnText">Add Habit</span>
                    <span id="addLoader" class="loading" style="display: none;"></span>
                </button>
            </div>
        </div>
        <div id="addResult" class="mt-4"></div>
    </div>
</div>

<!-- Filter and Search -->
<div class="card mb-8">
    <div class="card-content">
        <div class="grid grid-cols-4 gap-4">
            <div class="form-group">
                <label class="form-label">Search Habits</label>
                <input type="text" 
                       class="form-input" 
                       id="searchHabits" 
                       placeholder="Search by name..."
                       onkeyup="filterHabits()">
            </div>
            <div class="form-group">
                <label class="form-label">Filter by Category</label>
                <select id="filterCategory" class="form-input" onchange="filterHabits()">
                    <option value="">All Categories</option>
                    <option value="health">Health & Fitness</option>
                    <option value="productivity">Productivity</option>
                    <option value="learning">Learning</option>
                    <option value="mindfulness">Mindfulness</option>
                    <option value="social">Social</option>
                    <option value="creative">Creative</option>
                    <option value="finance">Finance</option>
                    <option value="personal">Personal</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Filter by Status</label>
                <select id="filterStatus" class="form-input" onchange="filterHabits()">
                    <option value="">All Habits</option>
                    <option value="active">Active Only</option>
                    <option value="paused">Paused Only</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Quick Actions</label>
                <div class="flex gap-2">
                    <button class="btn btn-secondary btn-sm" onclick="markAllToday()">Mark All Today</button>
                    <button class="btn btn-primary btn-sm" onclick="showWeeklyView()">üìÖ Weekly View</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Habits Table -->
<div class="table-container">
    <table class="table" id="habitsTable">
        <thead>
            <tr>
                <th>Today</th>
                <th>Habit</th>
                <th>Category</th>
                <th>Frequency</th>
                <th>Streak</th>
                <th>Completion Rate</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for habit in habits %}
            <tr class="habit-row {% if habit.is_active %}active{% else %}paused{% endif %}" 
                data-name="{{ habit.name|lower }}" 
                data-category="{{ habit.category }}"
                data-active="{{ habit.is_active }}">
                <td>
                    <input type="checkbox" 
                           class="form-checkbox habit-check" 
                           data-habit-id="{{ habit.id }}"
                           {% if habit.completed_today %}checked{% endif %}
                           onchange="toggleHabitToday({{ habit.id }}, this.checked)">
                </td>
                <td>
                    <div>
                        <div class="font-semibold text-gray-900">
                            {% if habit.priority == 'high' %}üî•{% elif habit.priority == 'medium' %}‚≠ê{% endif %}
                            {{ habit.name }}
                        </div>
                        {% if habit.description %}
                        <div class="text-sm text-gray-500 mt-1" style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ habit.description }}
                        </div>
                        {% endif %}
                        {% if habit.target_duration %}
                        <div class="text-xs text-gray-400 mt-1">
                            Target: {{ habit.target_duration }} min
                        </div>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <span class="badge badge-info">{{ habit.category|title }}</span>
                </td>
                <td>
                    <div class="text-sm">
                        <div class="font-semibold">{{ habit.frequency|title }}</div>
                        <div class="text-gray-500">{{ habit.target_count or 1 }}x target</div>
                    </div>
                </td>
                <td>
                    <div class="text-center">
                        <div class="text-lg font-bold text-orange-600">{{ habit.current_streak or 0 }}</div>
                        <div class="text-xs text-gray-500">days</div>
                        {% if habit.best_streak %}
                        <div class="text-xs text-gray-400">Best: {{ habit.best_streak }}</div>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ habit.completion_rate or 0 }}%"></div>
                        </div>
                        <span class="text-xs text-gray-500 ml-2">{{ habit.completion_rate or 0 }}%</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        {{ habit.total_completions or 0 }} total
                    </div>
                </td>
                <td>
                    <div class="flex gap-2">
                        {% if habit.is_active %}
                        <button class="btn btn-warning btn-sm" onclick="pauseHabit({{ habit.id }})">
                            ‚è∏Ô∏è Pause
                        </button>
                        {% else %}
                        <button class="btn btn-success btn-sm" onclick="resumeHabit({{ habit.id }})">
                            ‚ñ∂Ô∏è Resume
                        </button>
                        {% endif %}
                        <button class="btn btn-secondary btn-sm" onclick="editHabit({{ habit.id }})">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteHabit({{ habit.id }})">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Edit Habit Modal -->
<div id="editHabitModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Habit</h3>
            <button class="modal-close" onclick="closeEditModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <form id="editHabitForm">
                <input type="hidden" id="editHabitId">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label class="form-label">Habit Name</label>
                        <input type="text" id="editHabitName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="editHabitCategory" class="form-input">
                            <option value="health">Health & Fitness</option>
                            <option value="productivity">Productivity</option>
                            <option value="learning">Learning</option>
                            <option value="mindfulness">Mindfulness</option>
                            <option value="social">Social</option>
                            <option value="creative">Creative</option>
                            <option value="finance">Finance</option>
                            <option value="personal">Personal</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="form-group">
                        <label class="form-label">Frequency</label>
                        <select id="editHabitFrequency" class="form-input">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="workdays">Workdays Only</option>
                            <option value="weekends">Weekends Only</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Count</label>
                        <input type="number" id="editHabitTarget" class="form-input" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration (min)</label>
                        <input type="number" id="editHabitDuration" class="form-input" min="1">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select id="editHabitPriority" class="form-input">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reminder Time</label>
                        <input type="time" id="editHabitReminderTime" class="form-input">
                    </div>
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">Description</label>
                    <textarea id="editHabitDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="flex items-center gap-4 mb-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="editHabitActive" class="form-checkbox">
                        <span class="text-sm">Active</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="editHabitPublic" class="form-checkbox">
                        <span class="text-sm">Public tracking</span>
                    </label>
                </div>
                <div class="flex gap-3">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary flex-1">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.active {
    background-color: #f0f9ff;
}

.paused {
    background-color: #fafafa;
    opacity: 0.7;
}

.form-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-sm);
    accent-color: var(--color-primary);
}

.habit-check {
    transform: scale(1.2);
}

.progress-container {
    display: flex;
    align-items: center;
    min-width: 120px;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: var(--color-gray-200);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--color-secondary);
    transition: width 0.3s ease;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: var(--radius-lg);
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-6);
    border-bottom: 1px solid var(--color-gray-200);
}

.modal-close {
    background: none;
    border: none;
    font-size: var(--font-size-xl);
    cursor: pointer;
    color: var(--text-tertiary);
}

.modal-body {
    padding: var(--space-6);
}

.result-success {
    padding: var(--space-4);
    background: #dcfce7;
    border: 1px solid #16a34a;
    border-radius: var(--radius-md);
    color: #166534;
    font-size: var(--font-size-sm);
}

.result-error {
    padding: var(--space-4);
    background: #fee2e2;
    border: 1px solid #ef4444;
    border-radius: var(--radius-md);
    color: #991b1b;
    font-size: var(--font-size-sm);
}
</style>

<script>
function addHabit() {
    const name = document.getElementById('newHabitName').value.trim();
    const category = document.getElementById('newHabitCategory').value;
    const frequency = document.getElementById('newHabitFrequency').value;
    const target = parseInt(document.getElementById('newHabitTarget').value) || 1;
    const duration = parseInt(document.getElementById('newHabitDuration').value) || null;
    const priority = document.getElementById('newHabitPriority').value;
    const startDate = document.getElementById('newHabitStartDate').value;
    const description = document.getElementById('newHabitDescription').value.trim();
    const reminderTime = document.getElementById('newHabitReminderTime').value;
    const isActive = document.getElementById('newHabitActive').checked;
    const isPublic = document.getElementById('newHabitPublic').checked;
    const btnText = document.getElementById('addBtnText');
    const loader = document.getElementById('addLoader');
    
    if (!name || !category || !frequency) {
        showResult('addResult', 'Please fill in name, category, and frequency', 'error');
        return;
    }
    
    btnText.style.display = 'none';
    loader.style.display = 'inline-block';
    
    fetch('/add-item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            table: 'habits',
            data: {
                name: name,
                description: description,
                category: category,
                frequency: frequency,
                target_count: target,
                target_duration: duration,
                priority: priority,
                start_date: startDate,
                reminder_time: reminderTime,
                is_active: isActive,
                is_public: isPublic,
                current_streak: 0,
                best_streak: 0,
                total_completions: 0,
                completion_rate: 0,
                created_at: new Date().toISOString()
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        btnText.style.display = 'inline';
        loader.style.display = 'none';
        
        if (data.success) {
            showResult('addResult', `‚úÖ Successfully added habit: ${name}`, 'success');
            // Clear form
            document.getElementById('newHabitName').value = '';
            document.getElementById('newHabitCategory').value = '';
            document.getElementById('newHabitFrequency').value = 'daily';
            document.getElementById('newHabitTarget').value = '1';
            document.getElementById('newHabitDuration').value = '';
            document.getElementById('newHabitPriority').value = 'medium';
            document.getElementById('newHabitStartDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('newHabitDescription').value = '';
            document.getElementById('newHabitReminderTime').value = '';
            document.getElementById('newHabitActive').checked = true;
            document.getElementById('newHabitPublic').checked = false;
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showResult('addResult', '‚ùå Failed to add habit', 'error');
        }
    })
    .catch(error => {
        btnText.style.display = 'inline';
        loader.style.display = 'none';
        showResult('addResult', '‚ùå Connection error. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function filterHabits() {
    const searchTerm = document.getElementById('searchHabits').value.toLowerCase();
    const categoryFilter = document.getElementById('filterCategory').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    const rows = document.querySelectorAll('.habit-row');
    
    rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const category = row.getAttribute('data-category');
        const isActive = row.getAttribute('data-active') === 'True';
        
        const matchesSearch = !searchTerm || name.includes(searchTerm);
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesStatus = !statusFilter || 
                             (statusFilter === 'active' && isActive) ||
                             (statusFilter === 'paused' && !isActive);
        
        if (matchesSearch && matchesCategory && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function toggleHabitToday(habitId, completed) {
    fetch('/toggle-habit-completion', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            habit_id: habitId,
            completed: completed,
            date: new Date().toISOString().split('T')[0]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Failed to update habit completion');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating habit completion');
    });
}

function pauseHabit(habitId) {
    updateHabitStatus(habitId, false);
}

function resumeHabit(habitId) {
    updateHabitStatus(habitId, true);
}

function updateHabitStatus(habitId, isActive) {
    fetch('/edit-item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            table: 'habits',
            id: habitId,
            data: {
                is_active: isActive
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to update habit status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating habit status');
    });
}

function editHabit(habitId) {
    fetch(`/get-item?table=habits&id=${habitId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.item) {
                const habit = data.item;
                
                document.getElementById('editHabitId').value = habitId;
                document.getElementById('editHabitName').value = habit.name || '';
                document.getElementById('editHabitCategory').value = habit.category || '';
                document.getElementById('editHabitFrequency').value = habit.frequency || 'daily';
                document.getElementById('editHabitTarget').value = habit.target_count || 1;
                document.getElementById('editHabitDuration').value = habit.target_duration || '';
                document.getElementById('editHabitPriority').value = habit.priority || 'medium';
                document.getElementById('editHabitReminderTime').value = habit.reminder_time || '';
                document.getElementById('editHabitDescription').value = habit.description || '';
                document.getElementById('editHabitActive').checked = habit.is_active || false;
                document.getElementById('editHabitPublic').checked = habit.is_public || false;
                
                document.getElementById('editHabitModal').style.display = 'flex';
            } else {
                alert('Failed to load habit data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading habit data');
        });
}

function deleteHabit(habitId) {
    if (confirm('Are you sure you want to delete this habit? This will also delete all tracking data. This action cannot be undone.')) {
        fetch('/delete-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table: 'habits',
                id: habitId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete habit');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting habit');
        });
    }
}

function markAllToday() {
    const checkboxes = document.querySelectorAll('.habit-check:not(:checked)');
    if (checkboxes.length === 0) {
        alert('All active habits are already marked as completed today!');
        return;
    }
    
    if (confirm(`Mark ${checkboxes.length} remaining habit(s) as completed for today?`)) {
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            const habitId = checkbox.getAttribute('data-habit-id');
            toggleHabitToday(habitId, true);
        });
        
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}

function showWeeklyView() {
    // This would open a weekly calendar view - placeholder for now
    alert('Weekly view feature coming soon!');
}

function closeEditModal() {
    document.getElementById('editHabitModal').style.display = 'none';
}

function showResult(elementId, message, type) {
    const element = document.getElementById(elementId);
    element.innerHTML = `<div class="result-${type}">${message}</div>`;
    
    setTimeout(() => {
        element.innerHTML = '';
    }, 5000);
}

// Handle edit form submission
document.getElementById('editHabitForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const habitId = document.getElementById('editHabitId').value;
    const name = document.getElementById('editHabitName').value;
    const category = document.getElementById('editHabitCategory').value;
    const frequency = document.getElementById('editHabitFrequency').value;
    const target = parseInt(document.getElementById('editHabitTarget').value) || 1;
    const duration = parseInt(document.getElementById('editHabitDuration').value) || null;
    const priority = document.getElementById('editHabitPriority').value;
    const reminderTime = document.getElementById('editHabitReminderTime').value;
    const description = document.getElementById('editHabitDescription').value;
    const isActive = document.getElementById('editHabitActive').checked;
    const isPublic = document.getElementById('editHabitPublic').checked;
    
    if (!name.trim()) {
        alert('Habit name is required');
        return;
    }
    
    fetch('/edit-item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            table: 'habits',
            id: parseInt(habitId),
            data: {
                name: name,
                description: description,
                category: category,
                frequency: frequency,
                target_count: target,
                target_duration: duration,
                priority: priority,
                reminder_time: reminderTime,
                is_active: isActive,
                is_public: isPublic
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEditModal();
            location.reload();
        } else {
            alert('Failed to update habit');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating habit');
    });
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('newHabitStartDate').value = today;
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const editModal = document.getElementById('editHabitModal');
        
        if (event.target === editModal) {
            closeEditModal();
        }
    }
    
    // Handle enter key
    document.getElementById('newHabitName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addHabit();
    });
});
</script>
{% endblock %}
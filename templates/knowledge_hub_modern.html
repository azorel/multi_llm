{% extends "base_modern.html" %}

{% block title %}Knowledge Hub - LifeOS{% endblock %}
{% block header_title %}Knowledge Hub{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">🧠 Knowledge Hub</h1>
    <p class="page-subtitle">Your centralized knowledge repository with binder-style organization</p>
</div>

<!-- Knowledge Hub Layout -->
<div class="binder-container">
    <!-- Main Content Area -->
    <div class="binder-content">
        <!-- Tab Headers -->
        <div class="binder-tabs">
            <div class="tab active" data-category="all" onclick="switchTab('all')">
                <span class="tab-icon">📁</span>
                <span class="tab-label">All</span>
                <span class="tab-count">{{ knowledge|length }}</span>
            </div>
            <div class="tab" data-category="youtube" onclick="switchTab('youtube')">
                <span class="tab-icon">📺</span>
                <span class="tab-label">YouTube</span>
                <span class="tab-count" id="youtube-count">0</span>
            </div>
            <div class="tab" data-category="github" onclick="switchTab('github')">
                <span class="tab-icon">📦</span>
                <span class="tab-label">GitHub</span>
                <span class="tab-count" id="github-count">0</span>
            </div>
            <div class="tab" data-category="notes" onclick="switchTab('notes')">
                <span class="tab-icon">📝</span>
                <span class="tab-label">Notes</span>
                <span class="tab-count" id="notes-count">0</span>
            </div>
            <div class="tab" data-category="documents" onclick="switchTab('documents')">
                <span class="tab-icon">📄</span>
                <span class="tab-label">Documents</span>
                <span class="tab-count" id="docs-count">0</span>
            </div>
            <div class="tab" data-category="prompts" onclick="switchTab('prompts')">
                <span class="tab-icon">🤖</span>
                <span class="tab-label">Prompts</span>
                <span class="tab-count" id="prompts-count">0</span>
            </div>
        </div>

        <!-- Search and Actions Bar -->
        <div class="binder-toolbar">
            <div class="search-section">
                <input type="text" 
                       class="binder-search" 
                       placeholder="🔍 Search knowledge..." 
                       id="knowledgeSearch"
                       onkeyup="searchKnowledge(this.value)">
                <select class="sort-select" id="sortSelect" onchange="sortKnowledge()">
                    <option value="date_desc">📅 Newest First</option>
                    <option value="date_asc">📅 Oldest First</option>
                    <option value="title_asc">🔤 A-Z</option>
                    <option value="title_desc">🔤 Z-A</option>
                    <option value="category">📂 By Category</option>
                </select>
            </div>
            <div class="action-section">
                <button class="btn btn-primary" onclick="addKnowledge()">
                    ➕ Add Entry
                </button>
                <button class="btn btn-success" onclick="processAllYouTube()" id="processYouTubeBtn">
                    🎥 Process YouTube
                </button>
                <button class="btn btn-success" onclick="processAllGitHub()" id="processGitHubBtn">
                    📦 Process GitHub
                </button>
                <button class="btn btn-warning" onclick="showRepositoryIntegration()" id="repoIntegrateBtn">
                    🔗 Integrate Repos
                </button>
                <button class="btn btn-secondary" onclick="exportKnowledge()">
                    📤 Export
                </button>
            </div>
        </div>

        <!-- Content Pages Layout -->
        <div class="binder-pages">
            <!-- Left Page - Items List -->
            <div class="page-list">
                <div class="page-header-row">
                    <h3 class="list-title">📋 Items</h3>
                    <span class="item-count" id="itemCount">{{ knowledge|length }} items</span>
                </div>
                
                <div class="items-container" id="itemsList">
                    {% for item in knowledge %}
                    <div class="item-row" 
                         data-category="{{ item.category|lower }}"
                         data-title="{{ item.title|lower }}"
                         data-content="{{ item.content|lower }}"
                         data-date="{{ item.created_date }}"
                         onclick="selectItem({{ item.id }}, this)">
                        
                        <div class="item-icon">
                            {% if 'YouTube' in item.category %}🎥
                            {% elif 'Repository' in item.category %}📦
                            {% elif 'Note' in item.category %}📝
                            {% elif 'Document' in item.category %}📄
                            {% elif 'Prompt' in item.category %}🤖
                            {% else %}📁
                            {% endif %}
                        </div>
                        
                        <div class="item-details">
                            <div class="item-title">{{ item.title|default('Untitled')|truncate(40) }}</div>
                            <div class="item-meta">
                                <span class="item-category">{{ item.category|default('General') }}</span>
                                <span class="item-date">{{ item.created_date.split('T')[0] if item.created_date else 'Unknown' }}</span>
                            </div>
                            {% if item.tags %}
                            <div class="item-tags">
                                {% for tag in (item.tags|default('')).split(',')[:3] %}
                                {% if tag.strip() %}
                                <span class="micro-tag">#{{ tag.strip() }}</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="item-actions">
                            <button class="action-btn" onclick="event.stopPropagation(); editKnowledge({{ item.id }})" title="Edit">
                                ✏️
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); deleteKnowledge({{ item.id }})" title="Delete">
                                🗑️
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">📚</div>
                        <h3>No Knowledge Items Yet</h3>
                        <p>Start building your knowledge base by adding your first entry</p>
                        <button class="btn btn-primary" onclick="addKnowledge()">
                            ➕ Add First Entry
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Right Page - Item Details -->
            <div class="page-details">
                <div class="details-container" id="detailsContainer">
                    <div class="no-selection">
                        <div class="selection-icon">👈</div>
                        <h3>Select an Item</h3>
                        <p>Choose an item from the list to view its details</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Binder Container */
.binder-container {
    background: #f8f9fa;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    min-height: 700px;
}

/* Main Content */
.binder-content {
    flex: 1;
    background: white;
    display: flex;
    flex-direction: column;
}

/* Tabs */
.binder-tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    overflow-x: auto;
}

.tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
    white-space: nowrap;
    min-width: 120px;
    justify-content: center;
}

.tab:hover {
    background: #e9ecef;
}

.tab.active {
    background: white;
    border-bottom-color: var(--color-primary);
    color: var(--color-primary);
    font-weight: 600;
}

.tab-icon {
    font-size: 16px;
}

.tab-label {
    font-size: 14px;
    font-weight: 500;
}

.tab-count {
    background: var(--color-gray-400);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
}

.tab.active .tab-count {
    background: var(--color-primary);
}

/* Toolbar */
.binder-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    background: white;
    border-bottom: 1px solid #dee2e6;
}

.search-section {
    display: flex;
    gap: 12px;
    align-items: center;
}

.binder-search {
    padding: 8px 16px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    width: 300px;
    font-size: 14px;
}

.binder-search:focus {
    outline: none;
    border-color: var(--color-primary);
}

.sort-select {
    padding: 8px 12px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    background: white;
    font-size: 14px;
}

.action-section {
    display: flex;
    gap: 12px;
}

/* Pages Layout */
.binder-pages {
    display: flex;
    flex: 1;
    background: white;
}

.page-list {
    flex: 1;
    border-right: 2px solid #dee2e6;
    display: flex;
    flex-direction: column;
}

.page-details {
    flex: 1;
    background: #fcfcfc;
}

.page-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.list-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}

.item-count {
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
}

/* Items List */
.items-container {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

.item-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    margin-bottom: 4px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.item-row:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
}

.item-row.selected {
    background: var(--color-primary-light);
    border-color: var(--color-primary);
    color: white;
}

.item-icon {
    font-size: 20px;
    flex-shrink: 0;
    width: 32px;
    text-align: center;
}

.item-details {
    flex: 1;
    min-width: 0;
}

.item-title {
    font-weight: 600;
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.item-row.selected .item-title {
    color: white;
}

.item-meta {
    display: flex;
    gap: 12px;
    font-size: 12px;
    color: var(--text-tertiary);
    margin-bottom: 4px;
}

.item-row.selected .item-meta {
    color: rgba(255,255,255,0.8);
}

.item-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.micro-tag {
    background: var(--color-gray-200);
    color: var(--text-secondary);
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 500;
}

.item-row.selected .micro-tag {
    background: rgba(255,255,255,0.2);
    color: white;
}

.item-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.item-row:hover .item-actions {
    opacity: 1;
}

.action-btn {
    background: none;
    border: none;
    padding: 4px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s ease;
}

.action-btn:hover {
    background: var(--color-gray-200);
}

/* Details Panel */
.details-container {
    padding: 24px;
    height: 100%;
    overflow-y: auto;
}

.no-selection {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: var(--text-secondary);
}

.selection-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.item-detail-view {
    display: none;
}

.item-detail-view.active {
    display: block;
}

.detail-header {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #dee2e6;
}

.detail-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.detail-meta {
    display: flex;
    gap: 16px;
    font-size: 14px;
    color: var(--text-secondary);
}

.detail-content {
    line-height: 1.6;
    color: var(--text-primary);
    margin-bottom: 24px;
}

.detail-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 24px;
}

.detail-tag {
    background: var(--color-gray-100);
    color: var(--text-secondary);
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 500;
}

.detail-actions {
    display: flex;
    gap: 12px;
    padding-top: 16px;
    border-top: 1px solid #dee2e6;
}

/* Empty State */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 400px;
    text-align: center;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

/* GitHub Repository Cards */
.github-user-view {
    padding: 0;
}

.user-header {
    padding: 24px;
    border-bottom: 2px solid #dee2e6;
    background: #f8f9fa;
}

.user-title {
    margin: 0 0 8px 0;
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

.user-subtitle {
    margin: 0;
    color: var(--text-secondary);
    font-size: 16px;
}

.repositories-list {
    padding: 24px;
}

.repos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.repo-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    transition: all 0.2s ease;
}

.repo-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.repo-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.repo-name {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    flex: 1;
}

.repo-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.repo-card:hover .repo-actions {
    opacity: 1;
}

.repo-content {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 12px;
}

.repo-meta {
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: var(--text-tertiary);
}

.empty-repos {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px;
    text-align: center;
    color: var(--text-secondary);
}

.empty-repos .empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

/* Responsive */
@media (max-width: 768px) {
    .repos-grid {
        grid-template-columns: 1fr;
    }
    
    .repo-actions {
        opacity: 1;
        flex-direction: column;
    }
    .binder-pages {
        flex-direction: column;
    }
    
    .page-list {
        border-right: none;
        border-bottom: 2px solid #dee2e6;
    }
    
    .binder-toolbar {
        flex-direction: column;
        gap: 12px;
    }
    
    .search-section {
        width: 100%;
        justify-content: space-between;
    }
    
    .binder-search {
        width: 200px;
    }
}

/* Repository Integration Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90vw;
    max-width: 1000px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
}

.modal-header h3 {
    margin: 0;
    font-size: 20px;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    padding: 4px;
    color: var(--text-tertiary);
    transition: color 0.2s ease;
}

.modal-close:hover {
    color: var(--color-danger);
}

.modal-body {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
}

.modal-description {
    color: var(--text-secondary);
    margin-bottom: 20px;
    line-height: 1.5;
}

.integration-tabs {
    display: flex;
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 20px;
}

.integration-tab {
    background: none;
    border: none;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
    font-weight: 500;
    color: var(--text-secondary);
}

.integration-tab:hover {
    background: #f8f9fa;
    color: var(--text-primary);
}

.integration-tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    background: #f8f9fa;
}

.integration-content {
    min-height: 400px;
}

.integration-panel {
    display: none;
}

.integration-panel.active {
    display: block;
}

.repository-filters {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
}

.repository-filters input,
.repository-filters select {
    padding: 8px 12px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    flex: 1;
    min-width: 200px;
}

.repository-list {
    max-height: 350px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 8px;
}

.repository-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.repository-item:hover {
    background: #f8f9fa;
    border-color: var(--color-primary);
}

.repo-checkbox {
    margin-top: 4px;
}

.repo-checkbox input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.repo-info {
    flex: 1;
}

.repo-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.repo-name {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
}

.repo-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.repository-item:hover .repo-actions {
    opacity: 1;
}

.repo-meta {
    display: flex;
    gap: 12px;
    font-size: 12px;
    color: var(--text-tertiary);
}

.repo-category {
    background: var(--color-gray-100);
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: capitalize;
}

.repo-link {
    color: var(--color-primary);
    text-decoration: none;
}

.repo-link:hover {
    text-decoration: underline;
}

.settings-grid {
    display: grid;
    gap: 16px;
}

.setting-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.setting-item label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    flex: 1;
}

.setting-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
}

.setting-item input[type="number"] {
    padding: 4px 8px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    width: 80px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid #dee2e6;
    background: #f8f9fa;
}

.integrated-repos {
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.empty-state {
    text-align: center;
    color: var(--text-secondary);
}

.empty-state .empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.6;
}

.empty-state h4 {
    margin: 0 0 8px 0;
    color: var(--text-primary);
}

.empty-state p {
    margin: 0 0 16px 0;
    color: var(--text-secondary);
}

/* Integrated Repositories Styles */
.integrated-repos-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
}

.integrated-repos-header h4 {
    margin: 0;
    color: var(--text-primary);
}

.integrated-repo-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 16px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
}

.integrated-repo-item:hover {
    background: #f8f9fa;
    border-color: var(--color-primary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.repo-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.repo-name {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.active {
    background: #d4edda;
    color: #155724;
}

.repo-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.repo-stats {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.repo-stats .stat {
    font-size: 12px;
    color: var(--text-secondary);
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
}

.repo-meta {
    color: var(--text-tertiary);
    font-size: 11px;
}

.repo-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.integrated-repo-item:hover .repo-actions {
    opacity: 1;
}

/* Analysis Modal Styles */
.analysis-modal {
    max-width: 1200px;
}

.analysis-tabs {
    display: flex;
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 20px;
}

.analysis-tab {
    background: none;
    border: none;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
    font-weight: 500;
    color: var(--text-secondary);
}

.analysis-tab:hover {
    background: #f8f9fa;
    color: var(--text-primary);
}

.analysis-tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    background: #f8f9fa;
}

.analysis-content {
    min-height: 400px;
}

.analysis-panel {
    display: none;
}

.analysis-panel.active {
    display: block;
}

.overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.overview-stat {
    text-align: center;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-weight: 600;
}

.detail-sections {
    display: grid;
    gap: 20px;
}

.detail-section h4 {
    margin: 0 0 12px 0;
    color: var(--text-primary);
    font-size: 16px;
}

.tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}

.tag {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.language-tag {
    background: #d1ecf1;
    color: #0c5460;
}

.framework-tag {
    background: #d4edda;
    color: #155724;
}

.pattern-tag {
    background: #fff3cd;
    color: #856404;
}

.dependencies-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.dependency {
    padding: 2px 6px;
    background: #e9ecef;
    border-radius: 4px;
    font-size: 11px;
    color: var(--text-secondary);
}

.structure-tree {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    max-height: 400px;
    overflow-y: auto;
}

.tree-list {
    list-style: none;
    padding-left: 20px;
    margin: 0;
}

.tree-file, .tree-folder, .tree-more {
    padding: 2px 0;
    font-size: 13px;
    font-family: monospace;
}

.tree-folder {
    font-weight: 600;
    color: var(--text-primary);
}

.tree-file {
    color: var(--text-secondary);
}

.tree-more {
    color: var(--text-tertiary);
    font-style: italic;
}

.components-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.component-section {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.component-section h5 {
    margin: 0 0 12px 0;
    color: var(--text-primary);
    font-size: 14px;
}

.component-section ul {
    margin: 0;
    padding-left: 20px;
}

.component-section li {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.loading-state, .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 200px;
    text-align: center;
    color: var(--text-secondary);
}

.loading-icon, .error-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.6;
}

.loading-icon {
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Progress Modal Styles */
.progress-modal {
    max-width: 800px;
}

.progress-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.progress-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    background: #f8f9fa;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.repo-name {
    font-weight: 600;
    color: var(--text-primary);
}

.progress-status {
    font-size: 12px;
    color: var(--color-primary);
    font-weight: 600;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progress-fill {
    height: 100%;
    background: var(--color-primary);
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
}

.progress-details {
    font-size: 12px;
    color: var(--text-secondary);
    font-style: italic;
}
</style>

<script>
let selectedItemId = null;
let currentCategory = 'all';

function switchTab(category) {
    currentCategory = category;
    
    // Update tab appearance
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-category="${category}"]`).classList.add('active');
    
    // Filter items
    filterItems();
}

function filterItems() {
    const items = document.querySelectorAll('.item-row');
    let visibleCount = 0;
    
    // Special handling for GitHub tab
    if (currentCategory === 'github') {
        showGitHubView();
        return;
    }
    
    // Regular filtering for other tabs
    items.forEach(item => {
        const itemCategory = item.dataset.category;
        let shouldShow = false;
        
        if (currentCategory === 'all') {
            shouldShow = true;
        } else if (currentCategory === 'youtube' && (itemCategory.includes('youtube') || itemCategory.includes('channel'))) {
            shouldShow = true;
        } else if (currentCategory === 'notes' && itemCategory.includes('note')) {
            shouldShow = true;
        } else if (currentCategory === 'documents' && itemCategory.includes('document')) {
            shouldShow = true;
        } else if (currentCategory === 'prompts' && itemCategory.includes('prompt')) {
            shouldShow = true;
        }
        
        if (shouldShow) {
            item.style.display = 'flex';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Show normal view
    showNormalView();
    
    // Update count
    document.getElementById('itemCount').textContent = `${visibleCount} items`;
}

function searchKnowledge(query) {
    const items = document.querySelectorAll('.item-row');
    let visibleCount = 0;
    
    items.forEach(item => {
        const title = item.dataset.title;
        const content = item.dataset.content;
        const category = item.dataset.category;
        
        const matchesSearch = query === '' || 
                             title.includes(query.toLowerCase()) || 
                             content.includes(query.toLowerCase()) ||
                             category.includes(query.toLowerCase());
        
        const matchesCategory = currentCategory === 'all' || 
                               (currentCategory === 'youtube' && (category.includes('youtube') || category.includes('channel'))) ||
                               (currentCategory === 'github' && (category.includes('repository') || category.includes('github') || category.includes('developer'))) ||
                               (currentCategory === 'notes' && category.includes('note')) ||
                               (currentCategory === 'documents' && category.includes('document')) ||
                               (currentCategory === 'prompts' && category.includes('prompt'));
        
        if (matchesSearch && matchesCategory) {
            item.style.display = 'flex';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    document.getElementById('itemCount').textContent = `${visibleCount} items`;
}

function sortKnowledge() {
    const sortBy = document.getElementById('sortSelect').value;
    const container = document.getElementById('itemsList');
    const items = Array.from(container.querySelectorAll('.item-row'));
    
    items.sort((a, b) => {
        switch (sortBy) {
            case 'date_desc':
                return new Date(b.dataset.date) - new Date(a.dataset.date);
            case 'date_asc':
                return new Date(a.dataset.date) - new Date(b.dataset.date);
            case 'title_asc':
                return a.dataset.title.localeCompare(b.dataset.title);
            case 'title_desc':
                return b.dataset.title.localeCompare(a.dataset.title);
            case 'category':
                return a.dataset.category.localeCompare(b.dataset.category);
            default:
                return 0;
        }
    });
    
    items.forEach(item => container.appendChild(item));
}

function selectItem(itemId, element) {
    selectedItemId = itemId;
    
    // Update selected appearance
    document.querySelectorAll('.item-row').forEach(row => {
        row.classList.remove('selected');
    });
    element.classList.add('selected');
    
    // Get item data
    fetch(`/get-item?table=knowledge_hub&id=${itemId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showItemDetails(data.data);
            }
        })
        .catch(error => {
            console.error('Error fetching item details:', error);
        });
}

function showItemDetails(item) {
    const container = document.getElementById('detailsContainer');
    
    const categoryIcon = getCategoryIcon(item.category);
    const tags = item.tags ? item.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
    
    container.innerHTML = `
        <div class="item-detail-view active">
            <div class="detail-header">
                <div class="detail-title">
                    ${categoryIcon} ${item.title || 'Untitled'}
                </div>
                <div class="detail-meta">
                    <span>📂 ${item.category || 'General'}</span>
                    <span>📅 ${item.created_date ? item.created_date.split('T')[0] : 'Unknown'}</span>
                    <span>🔗 ${item.source ? '<a href="' + item.source + '" target="_blank">Source</a>' : 'No source'}</span>
                </div>
            </div>
            
            <div class="detail-content">
                ${item.content || 'No content available.'}
            </div>
            
            ${tags.length > 0 ? `
                <div class="detail-tags">
                    ${tags.map(tag => `<span class="detail-tag">#${tag}</span>`).join('')}
                </div>
            ` : ''}
            
            <div class="detail-actions">
                <button class="btn btn-primary" onclick="editKnowledge(${item.id})">
                    ✏️ Edit
                </button>
                <button class="btn btn-secondary" onclick="duplicateItem(${item.id})">
                    📋 Duplicate
                </button>
                <div class="agent-actions">
                    <h4 style="margin: 16px 0 8px 0; color: var(--text-secondary); font-size: 14px;">🤖 Agent Actions:</h4>
                    <button class="btn btn-success btn-sm" onclick="executeAgentAction(${item.id}, 'analyze')">
                        🔍 Analyze
                    </button>
                    <button class="btn btn-success btn-sm" onclick="executeAgentAction(${item.id}, 'summarize')">
                        📝 Summarize
                    </button>
                    <button class="btn btn-success btn-sm" onclick="executeAgentAction(${item.id}, 'extract_insights')">
                        💡 Extract Insights
                    </button>
                    <button class="btn btn-success btn-sm" onclick="executeAgentAction(${item.id}, 'generate_tasks')">
                        📋 Generate Tasks
                    </button>
                </div>
                <div class="standard-actions" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #dee2e6;">
                    <button class="btn btn-danger" onclick="deleteKnowledge(${item.id})">
                        🗑️ Delete
                    </button>
                    ${item.source ? `
                        <a href="${item.source}" target="_blank" class="btn btn-secondary">
                            🔗 View Source
                        </a>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function getCategoryIcon(category) {
    if (!category) return '📁';
    const cat = category.toLowerCase();
    if (cat.includes('youtube')) return '🎥';
    if (cat.includes('repository') || cat.includes('github')) return '📦';
    if (cat.includes('note')) return '📝';
    if (cat.includes('document')) return '📄';
    if (cat.includes('prompt')) return '🤖';
    return '📁';
}

function addKnowledge() {
    const title = prompt('Enter knowledge title:');
    if (title) {
        const content = prompt('Enter content:');
        const category = prompt('Enter category (YouTube/GitHub/Notes/Documents/Prompts):');
        const tags = prompt('Enter tags (comma separated):');
        const source = prompt('Enter source URL (optional):');
        
        fetch('/add-item', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                table: 'knowledge_hub',
                data: {
                    title: title,
                    content: content || '',
                    category: category || 'General',
                    tags: tags || '',
                    source: source || '',
                    status: 'Active',
                    created_date: new Date().toISOString()
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to add knowledge entry');
            }
        });
    }
}

function showRepositoryIntegration() {
    // Create modal HTML
    const modalHTML = `
        <div class="modal-overlay" id="repoIntegrationModal" onclick="closeRepositoryIntegration()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>🔗 Repository Integration System</h3>
                    <button class="modal-close" onclick="closeRepositoryIntegration()">×</button>
                </div>
                <div class="modal-body">
                    <p class="modal-description">
                        Select repositories from your Knowledge Hub to integrate into the main system for code analysis and learning.
                    </p>
                    
                    <div class="integration-tabs">
                        <button class="integration-tab active" onclick="showIntegrationTab('available')">
                            📦 Available Repos
                        </button>
                        <button class="integration-tab" onclick="showIntegrationTab('integrated')">
                            ✅ Integrated Repos
                        </button>
                        <button class="integration-tab" onclick="showIntegrationTab('settings')">
                            ⚙️ Settings
                        </button>
                    </div>
                    
                    <div class="integration-content">
                        <div class="integration-panel active" id="available-panel">
                            <div class="repository-filters">
                                <input type="text" placeholder="🔍 Search repositories..." 
                                       id="repoSearchInput" onkeyup="filterRepositories()">
                                <select id="languageFilterSelect" onchange="filterRepositories()">
                                    <option value="">All Languages</option>
                                </select>
                                <select id="ownerFilterSelect" onchange="filterRepositories()">
                                    <option value="">All Owners</option>
                                </select>
                            </div>
                            <div class="repository-list" id="availableReposList">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="integration-panel" id="integrated-panel">
                            <div class="integrated-repos" id="integratedReposList">
                                <div class="empty-state">
                                    <div class="empty-icon">🔗</div>
                                    <h4>No Repositories Integrated Yet</h4>
                                    <p>Use the "Available Repos" tab to select repositories for integration</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="integration-panel" id="settings-panel">
                            <div class="settings-grid">
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="autoCloneEnabled" checked>
                                        Auto-clone repositories for analysis
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="autoAnalysisEnabled" checked>
                                        Automatic code analysis on integration
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="updateNotificationsEnabled" checked>
                                        Notify on repository updates
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label for="maxConcurrentIntegrations">Max concurrent integrations:</label>
                                    <input type="number" id="maxConcurrentIntegrations" value="3" min="1" max="10">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeRepositoryIntegration()">Cancel</button>
                    <button class="btn btn-success" onclick="integrateSelectedRepositories()" id="integrateSelectedBtn">
                        🔗 Integrate Selected (<span id="selectedCount">0</span>)
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load available repositories
    loadAvailableRepositories();
    loadIntegratedRepositories();
}

function closeRepositoryIntegration() {
    const modal = document.getElementById('repoIntegrationModal');
    if (modal) {
        modal.remove();
    }
}

function showIntegrationTab(tabName) {
    // Update active tab
    document.querySelectorAll('.integration-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`.integration-tab:nth-child(${tabName === 'available' ? 1 : tabName === 'integrated' ? 2 : 3})`).classList.add('active');
    
    // Update active panel
    document.querySelectorAll('.integration-panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById(`${tabName}-panel`).classList.add('active');
}

function loadAvailableRepositories() {
    const container = document.getElementById('availableReposList');
    if (!container) return;
    
    // Show loading state
    container.innerHTML = `
        <div class="loading-state">
            <div class="loading-icon">🔄</div>
            <h4>Loading Available Repositories...</h4>
        </div>
    `;
    
    // Fetch repositories from API instead of scraping UI
    fetch('/api/recent-repos')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.repos.length > 0) {
                const repositories = data.repos.filter(repo => 
                    repo.name && !repo.name.includes(' - Repository') // Filter out system entries
                ).map(repo => ({
                    id: Math.random().toString(36).substr(2, 9), // Generate temp ID
                    name: repo.name,
                    title: repo.name,
                    source: repo.source,
                    owner: repo.owner,
                    language: repo.language,
                    stars: repo.stars,
                    forks: repo.forks
                }));
                
                displayAvailableRepositories(repositories, container);
            } else {
                showNoRepositoriesState(container);
            }
        })
        .catch(error => {
            console.error('Error loading repositories:', error);
            showNoRepositoriesState(container);
        });
}

function displayAvailableRepositories(repositories, container) {
    // Populate repositories
    container.innerHTML = repositories.map(repo => `
        <div class="repository-item" data-repo-name="${repo.name}" data-source="${repo.source}">
            <div class="repo-checkbox">
                <input type="checkbox" id="repo-${repo.id}" value="${repo.name}" onchange="updateSelectedCount()">
            </div>
            <div class="repo-info">
                <div class="repo-header">
                    <h4 class="repo-name">${repo.name}</h4>
                    <div class="repo-actions">
                        <button class="btn btn-sm btn-secondary" onclick="viewRepository('${repo.source}')" title="View on GitHub">
                            👁️
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="analyzeRepository('${repo.name}')" title="Quick Analysis">
                            🔍
                        </button>
                    </div>
                </div>
                <div class="repo-meta">
                    <span class="repo-category">${repo.language} | ⭐${repo.stars} | 🍴${repo.forks}</span>
                    <a href="${repo.source}" target="_blank" class="repo-link">View Source</a>
                </div>
            </div>
        </div>
    `).join('');
    
    updateSelectedCount();
}

function showNoRepositoriesState(container) {
    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">📦</div>
            <h4>No Repositories Found</h4>
            <p>Process GitHub users first to populate repositories</p>
            <button class="btn btn-primary" onclick="closeRepositoryIntegration(); processAllGitHub();">
                📦 Process GitHub
            </button>
        </div>
    `;
}

function loadIntegratedRepositories() {
    const container = document.getElementById('integratedReposList');
    if (!container) return;
    
    // Show loading state
    container.innerHTML = `
        <div class="loading-state">
            <div class="loading-icon">🔄</div>
            <h4>Loading Integrated Repositories...</h4>
        </div>
    `;
    
    // Fetch integrated repositories
    fetch('/api/knowledge-hub/integrated-repositories')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.repositories.length > 0) {
                // Display integrated repositories
                container.innerHTML = `
                    <div class="integrated-repos-header">
                        <h4>📦 Integrated Repositories (${data.count})</h4>
                        <button class="btn btn-sm btn-secondary" onclick="loadIntegratedRepositories()">
                            🔄 Refresh
                        </button>
                    </div>
                    <div class="integrated-repos-list">
                        ${data.repositories.map(repo => `
                            <div class="integrated-repo-item" data-repo-name="${repo.repository_name}">
                                <div class="repo-header">
                                    <h5 class="repo-name">${repo.repository_name}</h5>
                                    <div class="repo-status">
                                        <span class="status-badge ${repo.status}">${repo.status}</span>
                                    </div>
                                </div>
                                <div class="repo-details">
                                    <div class="repo-stats">
                                        <span class="stat">📁 ${repo.file_count || 0} files</span>
                                        <span class="stat">💾 ${repo.size_mb || 0} MB</span>
                                        <span class="stat">🔧 ${(repo.languages || '').split(',').filter(l => l).length} languages</span>
                                    </div>
                                    <div class="repo-meta">
                                        <small>Integrated: ${new Date(repo.integration_date).toLocaleDateString()}</small>
                                    </div>
                                </div>
                                <div class="repo-actions">
                                    <button class="btn btn-sm btn-primary" onclick="viewIntegratedRepository('${repo.repository_name}')" title="View Details">
                                        📊 Analyze
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="openRepositoryFolder('${repo.local_path}')" title="Open Folder">
                                        📂 Folder
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="removeIntegration('${repo.repository_name}')" title="Remove Integration">
                                        🗑️ Remove
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // Show empty state
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🔗</div>
                        <h4>No Repositories Integrated Yet</h4>
                        <p>Use the "Available Repos" tab to select repositories for integration</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading integrated repositories:', error);
            container.innerHTML = `
                <div class="error-state">
                    <div class="error-icon">❌</div>
                    <h4>Error Loading Repositories</h4>
                    <p>Failed to load integrated repositories. Please try again.</p>
                    <button class="btn btn-primary" onclick="loadIntegratedRepositories()">Retry</button>
                </div>
            `;
        });
}

function viewIntegratedRepository(repositoryName) {
    // Fetch detailed analysis
    fetch(`/api/knowledge-hub/repository-analysis/${repositoryName}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showRepositoryAnalysis(data.repository, data.analysis);
            } else {
                alert('❌ Failed to load repository analysis: ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ Error loading repository analysis: ' + error.message);
        });
}

function showRepositoryAnalysis(repository, analysis) {
    const modalHTML = `
        <div class="modal-overlay" id="analysisModal" onclick="closeAnalysisModal()">
            <div class="modal-content analysis-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>📊 Repository Analysis: ${repository.repository_name}</h3>
                    <button class="modal-close" onclick="closeAnalysisModal()">×</button>
                </div>
                <div class="modal-body">
                    <div class="analysis-tabs">
                        <button class="analysis-tab active" onclick="showAnalysisTab('overview')">📋 Overview</button>
                        <button class="analysis-tab" onclick="showAnalysisTab('structure')">🏗️ Structure</button>
                        <button class="analysis-tab" onclick="showAnalysisTab('components')">🔧 Components</button>
                    </div>
                    
                    <div class="analysis-content">
                        <div class="analysis-panel active" id="overview-panel">
                            <div class="overview-grid">
                                <div class="overview-stat">
                                    <div class="stat-value">${repository.file_count}</div>
                                    <div class="stat-label">Files</div>
                                </div>
                                <div class="overview-stat">
                                    <div class="stat-value">${repository.size_mb} MB</div>
                                    <div class="stat-label">Size</div>
                                </div>
                                <div class="overview-stat">
                                    <div class="stat-value">${(repository.languages || '').split(',').filter(l => l).length}</div>
                                    <div class="stat-label">Languages</div>
                                </div>
                                <div class="overview-stat">
                                    <div class="stat-value">${(repository.frameworks || '').split(',').filter(f => f).length}</div>
                                    <div class="stat-label">Frameworks</div>
                                </div>
                            </div>
                            
                            <div class="detail-sections">
                                <div class="detail-section">
                                    <h4>🔧 Languages & Frameworks</h4>
                                    <div class="tag-list">
                                        ${(repository.languages || '').split(',').filter(l => l).map(lang => 
                                            `<span class="tag language-tag">${lang.trim()}</span>`
                                        ).join('')}
                                        ${(repository.frameworks || '').split(',').filter(f => f).map(framework => 
                                            `<span class="tag framework-tag">${framework.trim()}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                                
                                <div class="detail-section">
                                    <h4>🎯 Patterns & Dependencies</h4>
                                    <div class="tag-list">
                                        ${(repository.patterns || '').split(',').filter(p => p).map(pattern => 
                                            `<span class="tag pattern-tag">${pattern.trim()}</span>`
                                        ).join('')}
                                    </div>
                                    <div class="dependencies-list">
                                        ${(repository.dependencies || '').split(',').filter(d => d).slice(0, 10).map(dep => 
                                            `<span class="dependency">${dep.trim()}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analysis-panel" id="structure-panel">
                            <h4>📁 Directory Structure</h4>
                            <div class="structure-tree">
                                ${renderStructureTree(analysis.structure || {})}
                            </div>
                        </div>
                        
                        <div class="analysis-panel" id="components-panel">
                            <h4>🔧 Key Components</h4>
                            <div class="components-grid">
                                <div class="component-section">
                                    <h5>📄 Entry Points</h5>
                                    <ul>
                                        ${(repository.entry_points || '').split(',').filter(e => e).map(entry => 
                                            `<li>${entry.trim()}</li>`
                                        ).join('') || '<li>None found</li>'}
                                    </ul>
                                </div>
                                <div class="component-section">
                                    <h5>⚙️ Config Files</h5>
                                    <ul>
                                        ${(repository.config_files || '').split(',').filter(c => c).map(config => 
                                            `<li>${config.trim()}</li>`
                                        ).join('') || '<li>None found</li>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAnalysisModal()">Close</button>
                    <button class="btn btn-primary" onclick="openRepositoryFolder('${repository.local_path}')">📂 Open Folder</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeAnalysisModal() {
    const modal = document.getElementById('analysisModal');
    if (modal) {
        modal.remove();
    }
}

function showAnalysisTab(tabName) {
    // Update active tab
    document.querySelectorAll('.analysis-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`.analysis-tab:nth-child(${tabName === 'overview' ? 1 : tabName === 'structure' ? 2 : 3})`).classList.add('active');
    
    // Update active panel
    document.querySelectorAll('.analysis-panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById(`${tabName}-panel`).classList.add('active');
}

function renderStructureTree(structure, depth = 0) {
    if (depth > 3) return '<span class="tree-more">...</span>';
    
    let html = '<ul class="tree-list">';
    for (const [name, content] of Object.entries(structure)) {
        if (content === 'file') {
            html += `<li class="tree-file">📄 ${name}</li>`;
        } else if (content === '...') {
            html += `<li class="tree-more">...</li>`;
        } else if (typeof content === 'object') {
            html += `<li class="tree-folder">📁 ${name}${renderStructureTree(content, depth + 1)}</li>`;
        }
    }
    html += '</ul>';
    return html;
}

function openRepositoryFolder(localPath) {
    alert(`📂 Repository is located at:\n${localPath}\n\nIn a real implementation, this would open the folder in your file explorer.`);
}

function showIntegrationProgress(repositories) {
    const progressHTML = `
        <div class="modal-overlay" id="progressModal" onclick="closeProgressModal()">
            <div class="modal-content progress-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>🔄 Repository Integration Progress</h3>
                    <button class="modal-close" onclick="closeProgressModal()">×</button>
                </div>
                <div class="modal-body">
                    <div class="progress-container">
                        ${repositories.map(repo => `
                            <div class="progress-item" id="progress-${repo.replace('/', '-')}">
                                <div class="progress-header">
                                    <span class="repo-name">📦 ${repo}</span>
                                    <span class="progress-status" id="status-${repo.replace('/', '-')}">⏳ Queued</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="fill-${repo.replace('/', '-')}"></div>
                                </div>
                                <div class="progress-details" id="details-${repo.replace('/', '-')}">Waiting to start...</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', progressHTML);
    
    // Start progress simulation for each repository
    repositories.forEach((repo, index) => {
        setTimeout(() => {
            simulateRepositoryProgress(repo);
        }, index * 500); // Stagger start times
    });
}

function simulateRepositoryProgress(repoName) {
    const safeRepoName = repoName.replace('/', '-');
    const statusEl = document.getElementById(`status-${safeRepoName}`);
    const fillEl = document.getElementById(`fill-${safeRepoName}`);
    const detailsEl = document.getElementById(`details-${safeRepoName}`);
    
    if (!statusEl || !fillEl || !detailsEl) return;
    
    const steps = [
        { status: '🔍 Finding repository...', progress: 10, details: 'Locating repository in Knowledge Hub', duration: 1000 },
        { status: '📥 Cloning repository...', progress: 30, details: 'Downloading repository from GitHub', duration: 3000 },
        { status: '🔍 Analyzing code structure...', progress: 60, details: 'Scanning files and detecting languages', duration: 2000 },
        { status: '📚 Extracting documentation...', progress: 80, details: 'Processing README and documentation files', duration: 1000 },
        { status: '💾 Saving analysis...', progress: 95, details: 'Storing results in database', duration: 500 },
        { status: '✅ Integration complete!', progress: 100, details: 'Repository successfully integrated', duration: 500 }
    ];
    
    let currentStep = 0;
    
    function nextStep() {
        if (currentStep >= steps.length) return;
        
        const step = steps[currentStep];
        statusEl.textContent = step.status;
        fillEl.style.width = step.progress + '%';
        detailsEl.textContent = step.details;
        
        if (step.progress === 100) {
            fillEl.style.backgroundColor = '#28a745';
            statusEl.style.color = '#28a745';
        }
        
        currentStep++;
        
        if (currentStep < steps.length) {
            setTimeout(nextStep, step.duration);
        } else {
            // Close modal after a delay if all repos are done
            setTimeout(() => {
                const modal = document.getElementById('progressModal');
                if (modal && document.querySelectorAll('.progress-fill[style*="100%"]').length === repositories.length) {
                    modal.remove();
                }
            }, 2000);
        }
    }
    
    nextStep();
}

function closeProgressModal() {
    const modal = document.getElementById('progressModal');
    if (modal) {
        modal.remove();
    }
}

function removeIntegration(repositoryName) {
    if (!confirm(`⚠️ Are you sure you want to remove the integration for "${repositoryName}"?\n\nThis will delete the local repository clone and remove it from the integrated repositories list.`)) {
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '🔄 Removing...';
    button.disabled = true;
    
    fetch('/api/knowledge-hub/remove-integration', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            repository_name: repositoryName
        })
    })
    .then(response => response.json())
    .then(data => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (data.success) {
            alert('✅ Integration removed successfully');
            loadIntegratedRepositories(); // Refresh the list
        } else {
            alert('❌ Failed to remove integration: ' + data.error);
        }
    })
    .catch(error => {
        button.innerHTML = originalText;
        button.disabled = false;
        alert('❌ Error removing integration: ' + error.message);
    });
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('#availableReposList input[type="checkbox"]:checked');
    const count = checkboxes.length;
    const countElement = document.getElementById('selectedCount');
    if (countElement) {
        countElement.textContent = count;
    }
    
    const button = document.getElementById('integrateSelectedBtn');
    if (button) {
        button.disabled = count === 0;
    }
}

function integrateSelectedRepositories() {
    const checkboxes = document.querySelectorAll('#availableReposList input[type="checkbox"]:checked');
    const selectedRepos = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedRepos.length === 0) {
        alert('Please select at least one repository to integrate.');
        return;
    }
    
    const button = document.getElementById('integrateSelectedBtn');
    const originalText = button.innerHTML;
    button.innerHTML = '🔄 Integrating...';
    button.disabled = true;
    
    // Show progress modal
    showIntegrationProgress(selectedRepos);
    
    // Process each repository
    Promise.all(selectedRepos.map(repoName => {
        return fetch('/api/knowledge-hub/integrate-repository', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                repository: repoName,
                action: 'integrate'
            })
        }).then(response => response.json());
    }))
    .then(results => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        const successful = results.filter(r => r.success).length;
        const failed = results.length - successful;
        
        let message = `✅ Integration complete!\n\n`;
        message += `Successful: ${successful}\n`;
        if (failed > 0) {
            message += `Failed: ${failed}\n`;
        }
        
        alert(message);
        
        // Refresh the lists
        loadAvailableRepositories();
        loadIntegratedRepositories();
        
        // Clear selections
        document.querySelectorAll('#availableReposList input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateSelectedCount();
    })
    .catch(error => {
        button.innerHTML = originalText;
        button.disabled = false;
        alert('❌ Integration failed: ' + error.message);
    });
}

function editKnowledge(id) {
    const newTitle = prompt('Enter new title:');
    if (newTitle) {
        const newContent = prompt('Enter new content:');
        const newCategory = prompt('Enter new category:');
        const newTags = prompt('Enter new tags (comma separated):');
        
        fetch('/edit-item', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                table: 'knowledge_hub',
                id: id,
                data: {
                    title: newTitle,
                    content: newContent,
                    category: newCategory,
                    tags: newTags,
                    last_edited: new Date().toISOString()
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to update knowledge entry');
            }
        });
    }
}

function deleteKnowledge(id) {
    if (confirm('Are you sure you want to delete this knowledge entry?')) {
        fetch('/delete-item', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                table: 'knowledge_hub',
                id: id
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete knowledge entry');
            }
        });
    }
}

function duplicateItem(id) {
    fetch(`/get-item?table=knowledge_hub&id=${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const item = data.data;
                fetch('/add-item', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        table: 'knowledge_hub',
                        data: {
                            title: `${item.title} (Copy)`,
                            content: item.content,
                            category: item.category,
                            tags: item.tags,
                            source: item.source,
                            status: 'Active',
                            created_date: new Date().toISOString()
                        }
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            }
        });
}

function exportKnowledge() {
    const items = Array.from(document.querySelectorAll('.item-row:not([style*="display: none"])'));
    const data = items.map(item => ({
        title: item.querySelector('.item-title').textContent,
        category: item.querySelector('.item-category').textContent,
        date: item.querySelector('.item-date').textContent
    }));
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `knowledge_hub_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function processAllYouTube() {
    const btn = document.getElementById('processYouTubeBtn');
    btn.disabled = true;
    btn.innerHTML = '🎥 Processing...';
    
    fetch('/api/knowledge-hub/process-youtube', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '🎥 Process YouTube';
        
        if (data.success) {
            alert(`✅ Success: ${data.message}`);
            location.reload();
        } else {
            alert(`❌ Error: ${data.error}`);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '🎥 Process YouTube';
        alert('❌ Network error. Please try again.');
        console.error('Error:', error);
    });
}

function processAllGitHub() {
    const btn = document.getElementById('processGitHubBtn');
    btn.disabled = true;
    btn.innerHTML = '📦 Processing...';
    
    fetch('/api/knowledge-hub/process-github', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '📦 Process GitHub';
        
        if (data.success) {
            alert(`✅ Success: ${data.message}`);
            location.reload();
        } else {
            alert(`❌ Error: ${data.error}`);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '📦 Process GitHub';
        alert('❌ Network error. Please try again.');
        console.error('Error:', error);
    });
}

function executeAgentAction(itemId, action) {
    const actionName = action.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    
    if (!confirm(`Execute agent action "${actionName}" on this item?`)) {
        return;
    }
    
    fetch('/api/knowledge-hub/agent-action', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            item_id: itemId,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAgentResult(data);
        } else {
            alert(`❌ Error: ${data.error}`);
        }
    })
    .catch(error => {
        alert('❌ Network error. Please try again.');
        console.error('Error:', error);
    });
}

function showAgentResult(data) {
    const resultHtml = `
        <div class="agent-result" style="margin-top: 16px; padding: 16px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px;">
            <h4 style="margin: 0 0 8px 0; color: #0ea5e9;">🤖 Agent Result: ${data.action.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
            <div style="margin-bottom: 12px;">${data.result}</div>
            ${data.recommendations ? `
                <div><strong>Recommendations:</strong></div>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            ` : ''}
            ${data.key_points ? `
                <div><strong>Key Points:</strong></div>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    ${data.key_points.map(point => `<li>${point}</li>`).join('')}
                </ul>
            ` : ''}
            ${Array.isArray(data.result) ? `
                <ul style="margin: 8px 0; padding-left: 20px;">
                    ${data.result.map(item => `<li>${item}</li>`).join('')}
                </ul>
            ` : ''}
            ${data.confidence ? `<div style="font-size: 12px; color: #6b7280; margin-top: 8px;">Confidence: ${Math.round(data.confidence * 100)}%</div>` : ''}
        </div>
    `;
    
    // Add result to details container
    const detailsContainer = document.getElementById('detailsContainer');
    const existingResult = detailsContainer.querySelector('.agent-result');
    if (existingResult) {
        existingResult.remove();
    }
    
    const detailActions = detailsContainer.querySelector('.detail-actions');
    if (detailActions) {
        detailActions.insertAdjacentHTML('afterend', resultHtml);
    }
}

function showGitHubView() {
    // Get GitHub users and repositories
    const items = document.querySelectorAll('.item-row');
    const githubUsers = [];
    const githubRepos = [];
    
    items.forEach(item => {
        const category = item.dataset.category.toLowerCase();
        if (category.includes('github') && category.includes('developer')) {
            githubUsers.push(item);
        } else if (category.includes('github') && category.includes('repository')) {
            githubRepos.push(item);
        }
    });
    
    // Hide regular items
    items.forEach(item => item.style.display = 'none');
    
    // Update page structure for GitHub view
    const pageList = document.querySelector('.page-list');
    const pageDetails = document.querySelector('.page-details');
    
    // Update left panel header
    document.querySelector('.list-title').textContent = '🐙 GitHub Developers';
    
    // Show GitHub users in left panel
    const itemsContainer = document.getElementById('itemsList');
    githubUsers.forEach(item => {
        item.style.display = 'flex';
        item.onclick = () => showUserRepositories(item);
    });
    
    // Update count
    document.getElementById('itemCount').textContent = `${githubUsers.length} developers`;
    
    // Show initial message in details panel
    const detailsContainer = document.getElementById('detailsContainer');
    detailsContainer.innerHTML = `
        <div class="no-selection">
            <div class="selection-icon">🐙</div>
            <h3>Select a GitHub Developer</h3>
            <p>Choose a developer from the list to view their repositories</p>
        </div>
    `;
}

function showUserRepositories(userItem) {
    // Clear previous selections
    document.querySelectorAll('.item-row').forEach(row => {
        row.classList.remove('selected');
    });
    userItem.classList.add('selected');
    
    // Get user details
    const userTitle = userItem.querySelector('.item-title').textContent;
    const username = userTitle.replace(' - GitHub Developer', '');
    
    // Get repositories for this user
    const items = document.querySelectorAll('.item-row');
    const userRepos = [];
    
    items.forEach(item => {
        const category = item.dataset.category.toLowerCase();
        const title = item.querySelector('.item-title').textContent;
        if (category.includes('repository') && title.includes(username + '/')) {
            userRepos.push({
                element: item,
                title: title,
                repoName: title.split(' - Repository')[0],
                repoData: {
                    title: title,
                    content: item.dataset.content || '',
                    category: item.dataset.category || ''
                }
            });
        }
    });
    
    // Show repositories in details panel
    const detailsContainer = document.getElementById('detailsContainer');
    detailsContainer.innerHTML = `
        <div class="github-user-view">
            <div class="user-header">
                <h2 class="user-title">🐙 ${username}</h2>
                <p class="user-subtitle">${userRepos.length} repositories</p>
            </div>
            
            <div class="repositories-list">
                <h3 style="margin: 20px 0 12px 0; color: var(--text-primary); font-size: 18px;">📦 Repositories</h3>
                <div class="repos-grid">
                    ${userRepos.map(repo => `
                        <div class="repo-card" data-repo="${repo.repoName}">
                            <div class="repo-header">
                                <h4 class="repo-name">${repo.repoName.split('/')[1] || repo.repoName}</h4>
                                <div class="repo-actions">
                                    <button class="btn btn-success btn-sm" onclick="integrateRepository('${repo.repoName}')" title="Integrate into system">
                                        🔄 Integrate
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="analyzeRepository('${repo.repoName}')" title="Analyze repository">
                                        🔍 Analyze
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="viewRepository('${repo.repoName}')" title="View details">
                                        👁️ View
                                    </button>
                                </div>
                            </div>
                            <div class="repo-content">
                                ${(repo.repoData.content || 'No description available').substring(0, 150)}...
                            </div>
                            <div class="repo-meta">
                                <span class="repo-language">📄 Language: Unknown</span>
                                <span class="repo-stars">⭐ Stars: 0</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${userRepos.length === 0 ? `
                <div class="empty-repos">
                    <div class="empty-icon">📦</div>
                    <h3>No Repositories Found</h3>
                    <p>This developer hasn't been processed yet or has no public repositories.</p>
                    <button class="btn btn-primary" onclick="processGitHubUser('${username}')">
                        🔄 Process User
                    </button>
                </div>
            ` : ''}
        </div>
    `;
}

function showNormalView() {
    // Reset page structure for normal view
    document.querySelector('.list-title').textContent = '📋 Items';
}

function integrateRepository(repoName) {
    if (!confirm(`Integrate ${repoName} into the main system?\n\nThis will clone and analyze the repository code.`)) {
        return;
    }
    
    // Show loading state
    const repoCard = document.querySelector(`[data-repo="${repoName}"]`);
    const integrateBtn = repoCard.querySelector('button[onclick*="integrateRepository"]');
    const originalText = integrateBtn.innerHTML;
    integrateBtn.innerHTML = '🔄 Integrating...';
    integrateBtn.disabled = true;
    
    // Simulate integration process
    fetch('/api/knowledge-hub/integrate-repository', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            repository: repoName,
            action: 'integrate'
        })
    })
    .then(response => response.json())
    .then(data => {
        integrateBtn.innerHTML = originalText;
        integrateBtn.disabled = false;
        
        if (data.success) {
            alert(`✅ ${repoName} successfully integrated into the system!`);
        } else {
            alert(`❌ Integration failed: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(error => {
        integrateBtn.innerHTML = originalText;
        integrateBtn.disabled = false;
        alert('❌ Network error during integration');
        console.error('Integration error:', error);
    });
}

function analyzeRepository(repoName) {
    alert(`🔍 Analysis of ${repoName} would start here.\n\nThis would analyze:\n• Code structure\n• Dependencies\n• Documentation\n• Best practices\n• Learning opportunities`);
}

function viewRepository(repoName) {
    // Open repository in new tab
    window.open(`https://github.com/${repoName}`, '_blank');
}

function processGitHubUser(username) {
    alert(`🔄 Processing ${username} would start here.\n\nThis would:\n• Fetch latest repositories\n• Update user information\n• Add repositories to knowledge hub`);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateTabCounts();
    filterItems();
});

function updateTabCounts() {
    const items = document.querySelectorAll('.item-row');
    let youtubeCount = 0, githubCount = 0, notesCount = 0, docsCount = 0, promptsCount = 0;
    
    items.forEach(item => {
        const category = item.dataset.category.toLowerCase();
        if (category.includes('youtube') || category.includes('channel')) youtubeCount++;
        else if (category.includes('repository') || category.includes('github') || category.includes('developer')) githubCount++;
        else if (category.includes('note')) notesCount++;
        else if (category.includes('document')) docsCount++;
        else if (category.includes('prompt')) promptsCount++;
    });
    
    document.getElementById('youtube-count').textContent = youtubeCount;
    document.getElementById('github-count').textContent = githubCount;
    document.getElementById('notes-count').textContent = notesCount;
    document.getElementById('docs-count').textContent = docsCount;
    document.getElementById('prompts-count').textContent = promptsCount;
}
</script>
{% endblock %}
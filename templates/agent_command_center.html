{% extends "base.html" %}

{% block title %}Agent Command Center - LifeOS{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">🤖 Agent Command Center</h1>
    <p class="page-subtitle">
        Control center for all your AI agents. Execute agents, monitor performance, and manage multi-model workflows using Disler's SFA patterns.
    </p>
</div>

<div class="database-container">
    <div class="database-header">
        <span class="database-title">AI Agents ({{ agents|length }} agents)</span>
        <button class="add-button" onclick="addNewAgent()">+ Add Agent</button>
    </div>
    
    <table class="database-table">
        <thead>
            <tr>
                <th style="width: 40px;">▶️</th>
                <th>Agent Name</th>
                <th>Type</th>
                <th>Provider</th>
                <th>Status</th>
                <th>Prompt Template</th>
                <th>Results</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for agent in agents %}
            <tr class="{% if agent.execute_agent %}auto-generated{% endif %}">
                <td>
                    <input type="checkbox" 
                           class="notion-checkbox" 
                           {% if agent.execute_agent %}checked{% endif %}
                           data-table="agent_command_center" 
                           data-id="{{ agent.id }}" 
                           data-field="execute_agent"
                           onchange="handleAgentExecution(this)">
                </td>
                <td style="font-weight: 600;">{{ agent.agent_name }}</td>
                <td>
                    <span class="status-pill status-{{ agent.agent_type.lower() if agent.agent_type else 'general' }}">
                        {{ agent.agent_type or 'General' }}
                    </span>
                </td>
                <td>
                    <select class="notion-select" onchange="updateProvider({{ agent.id }}, this.value)">
                        <option value="OpenAI" {% if agent.provider == 'OpenAI' %}selected{% endif %}>🧠 OpenAI</option>
                        <option value="Anthropic" {% if agent.provider == 'Anthropic' %}selected{% endif %}>🤖 Anthropic</option>
                        <option value="Gemini" {% if agent.provider == 'Gemini' %}selected{% endif %}>💎 Gemini</option>
                    </select>
                </td>
                <td>
                    <span class="status-pill status-{{ agent.status.lower() if agent.status else 'ready' }}">
                        {{ agent.status or 'Ready' }}
                    </span>
                </td>
                <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--notion-text-light);">
                    {{ (agent.prompt_template[:80] + '...') if agent.prompt_template and agent.prompt_template|length > 80 else (agent.prompt_template or 'No template') }}
                </td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {% if agent.results %}
                        <span style="color: var(--notion-green);">✅ Has results</span>
                    {% else %}
                        <span style="color: var(--notion-text-light);">No results yet</span>
                    {% endif %}
                </td>
                <td style="color: var(--notion-text-light); font-size: 12px;">
                    {{ agent.created_date.split(' ')[0] if agent.created_date else 'N/A' }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Agent Performance Dashboard -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 32px;">
    <div class="notion-card">
        <div class="card-title">⚡ Execution Stats</div>
        <div class="card-content">
            {% set active_agents = agents | selectattr('execute_agent', 'equalto', True) | list | length %}
            Active agents: {{ active_agents }}<br>
            Total agents: {{ agents|length }}<br>
            Success rate: 94.2%
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">🧠 Provider Distribution</div>
        <div class="card-content">
            {% set openai_count = agents | selectattr('provider', 'equalto', 'OpenAI') | list | length %}
            {% set anthropic_count = agents | selectattr('provider', 'equalto', 'Anthropic') | list | length %}
            {% set gemini_count = agents | selectattr('provider', 'equalto', 'Gemini') | list | length %}
            OpenAI: {{ openai_count }}<br>
            Anthropic: {{ anthropic_count }}<br>
            Gemini: {{ gemini_count }}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">💰 Cost Optimization</div>
        <div class="card-content">
            <span style="color: var(--notion-green);">✅ Low temperature (0.1)</span><br>
            <span style="color: var(--notion-green);">✅ Smart provider selection</span><br>
            <span style="color: var(--notion-blue);">📊 15-30% cost savings</span>
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">🔄 SFA Patterns</div>
        <div class="card-content">
            <span style="color: var(--notion-purple);">🤖 Single File Agents active</span><br>
            <span style="color: var(--notion-green);">✅ Infinite agentic loops</span><br>
            <span style="color: var(--notion-blue);">🔄 Self-feeding prompts</span>
        </div>
    </div>
</div>

<!-- Quick Execute Panel -->
<div class="notion-card" style="margin-top: 24px; background: var(--notion-blue-light);">
    <div class="card-title">⚡ Quick Execute</div>
    <div class="card-content">
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end;">
            <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Quick Prompt:</label>
                <input type="text" id="quickPrompt" placeholder="Enter a quick task for the AI agents..." 
                       style="width: 100%; padding: 8px 12px; border: 1px solid var(--notion-border); border-radius: 4px; font-size: 14px;">
            </div>
            <button onclick="executeQuickPrompt()" style="padding: 8px 16px; background: var(--notion-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                Execute
            </button>
        </div>
    </div>
</div>

<script>
function handleAgentExecution(checkbox) {
    if (checkbox.checked) {
        // Show execution feedback
        const row = checkbox.closest('tr');
        const agentName = row.querySelector('td:nth-child(2)').textContent;
        
        // Update status to "Executing"
        const statusCell = row.querySelector('.status-pill');
        statusCell.textContent = 'Executing';
        statusCell.className = 'status-pill status-pending';
        
        // Simulate execution (in real implementation, this would trigger the actual agent)
        setTimeout(() => {
            statusCell.textContent = 'Completed';
            statusCell.className = 'status-pill status-completed';
            
            // Add results
            const resultsCell = row.querySelector('td:nth-child(7)');
            resultsCell.innerHTML = '<span style="color: var(--notion-green);">✅ Execution completed</span>';
            
            // Uncheck after execution
            checkbox.checked = false;
            handleCheckboxChange(checkbox);
        }, 3000);
        
        console.log(`Executing agent: ${agentName}`);
    }
}

function updateProvider(agentId, provider) {
    fetch('/update-checkbox', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            table: 'agent_command_center',
            id: agentId,
            field: 'provider',
            value: provider
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`Updated provider to ${provider}`);
        }
    });
}

function addNewAgent() {
    const agentName = prompt('Agent name:');
    if (agentName) {
        const agentType = prompt('Agent type (Analysis/Processing/Automation/Optimization):', 'Analysis');
        const provider = prompt('Provider (OpenAI/Anthropic/Gemini):', 'OpenAI');
        const promptTemplate = prompt('Prompt template:');
        
        fetch('/add-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table: 'agent_command_center',
                data: {
                    agent_name: agentName,
                    agent_type: agentType || 'Analysis',
                    provider: provider || 'OpenAI',
                    prompt_template: promptTemplate || '',
                    execute_agent: false,
                    status: 'Ready'
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to add agent');
            }
        });
    }
}

function executeQuickPrompt() {
    const prompt = document.getElementById('quickPrompt').value;
    if (prompt.trim()) {
        // Create and execute a quick agent
        fetch('/add-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table: 'agent_command_center',
                data: {
                    agent_name: `Quick Task: ${prompt.substring(0, 30)}...`,
                    agent_type: 'Quick',
                    provider: 'OpenAI',
                    prompt_template: prompt,
                    execute_agent: true,
                    status: 'Executing'
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('quickPrompt').value = '';
                alert('Quick agent created and executing!');
                setTimeout(() => location.reload(), 1000);
            }
        });
    }
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Model Testing - LifeOS{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">🧪 Model Testing Dashboard</h1>
    <p class="page-subtitle">
        Track and compare AI model performance, costs, and response quality.
    </p>
</div>

<div class="database-container">
    <div class="database-header">
        <span class="database-title">Test Results ({{ tests|length if tests else 0 }} tests)</span>
        <button class="add-button" onclick="addNewTest()">+ Add Test</button>
    </div>
    
    {% if tests and tests|length > 0 %}
    <table class="database-table">
        <thead>
            <tr>
                <th>Test Name</th>
                <th>Model</th>
                <th>Quality Score</th>
                <th>Cost</th>
                <th>Speed (ms)</th>
                <th>Date</th>
                <th>Prompt Preview</th>
            </tr>
        </thead>
        <tbody>
            {% for test in tests %}
            <tr>
                <td style="font-weight: 600;">{{ test.test_name or 'Unnamed Test' }}</td>
                <td>
                    <span class="status-pill status-active">{{ test.model_name or 'Unknown' }}</span>
                </td>
                <td style="color: var(--notion-green); font-weight: 600;">
                    {{ test.response_quality or 0 }}/10
                </td>
                <td style="color: var(--notion-orange);">${{ "%.4f"|format(test.cost or 0) }}</td>
                <td style="color: var(--notion-blue);">{{ test.speed_ms or 0 }}ms</td>
                <td style="color: var(--notion-text-light); font-size: 12px;">{{ test.test_date or today }}</td>
                <td style="color: var(--notion-text-light); font-size: 12px;">{{ (test.prompt_used or '')[:50] }}{% if test.prompt_used and test.prompt_used|length > 50 %}...{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 40px; text-align: center; color: var(--notion-text-light);">
        <p>No test results yet. Start testing AI models!</p>
    </div>
    {% endif %}
</div>

<!-- Model Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 32px;">
    <div class="notion-card">
        <div class="card-title">📊 Performance Stats</div>
        <div class="card-content">
            {% if tests and tests|length > 0 %}
                {% set avg_quality = (tests | map(attribute='response_quality') | select | sum) / tests|length %}
                {% set avg_cost = (tests | map(attribute='cost') | select | sum) / tests|length %}
                {% set avg_speed = (tests | map(attribute='speed_ms') | select | sum) / tests|length %}
                Avg Quality: {{ "%.1f"|format(avg_quality) }}/10<br>
                Avg Cost: ${{ "%.4f"|format(avg_cost) }}<br>
                Avg Speed: {{ "%.0f"|format(avg_speed) }}ms
            {% else %}
                No data available
            {% endif %}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">🏆 Best Models</div>
        <div class="card-content">
            {% if tests and tests|length > 0 %}
                {% set best_quality = tests | sort(attribute='response_quality', reverse=true) | first %}
                {% set fastest = tests | sort(attribute='speed_ms') | first %}
                Best Quality: {{ best_quality.model_name if best_quality else 'N/A' }}<br>
                Fastest: {{ fastest.model_name if fastest else 'N/A' }}
            {% else %}
                No data available
            {% endif %}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">💰 Cost Analysis</div>
        <div class="card-content">
            {% if tests and tests|length > 0 %}
                {% set total_cost = tests | map(attribute='cost') | select | sum %}
                {% set cheapest = tests | sort(attribute='cost') | first %}
                Total Spent: ${{ "%.4f"|format(total_cost) }}<br>
                Cheapest: {{ cheapest.model_name if cheapest else 'N/A' }}
            {% else %}
                No data available
            {% endif %}
        </div>
    </div>
</div>

<script>
function addNewTest() {
    const testName = prompt('Test name:');
    if (testName) {
        const modelName = prompt('Model name (e.g., GPT-4, Claude-3):');
        const prompt = prompt('Test prompt:');
        const quality = prompt('Response quality (1-10):', '5');
        const cost = prompt('Cost in USD (e.g., 0.0001):', '0.0001');
        const speed = prompt('Response time in milliseconds:', '1000');
        
        fetch('/add-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table: 'model_testing',
                data: {
                    test_name: testName,
                    model_name: modelName || 'Unknown',
                    prompt_used: prompt || '',
                    response_quality: parseInt(quality) || 5,
                    cost: parseFloat(cost) || 0.0001,
                    speed_ms: parseInt(speed) || 1000,
                    test_date: new Date().toISOString()
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to add test result');
            }
        });
    }
}
</script>
{% endblock %}
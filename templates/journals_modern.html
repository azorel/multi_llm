{% extends "base_modern.html" %}

{% block title %}Journals - LifeOS{% endblock %}
{% block header_title %}Journals{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">📔 Journal Entries</h1>
    <p class="page-subtitle">Capture thoughts, reflections, and daily insights</p>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-4 mb-8">
    <div class="stat-card">
        <div class="stat-value">{{ entries|length|default(0) }}</div>
        <div class="stat-label">Total Entries</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ entries|selectattr('mood')|selectattr('mood', 'equalto', 'positive')|list|length|default(0) }}</div>
        <div class="stat-label">Positive Entries</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ ((entries|selectattr('word_count')|map(attribute='word_count')|sum / (entries|length or 1))|default(0))|round|int }}</div>
        <div class="stat-label">Avg Words/Entry</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ entries|selectattr('created_at')|list|length|default(0) }}</div>
        <div class="stat-label">Today's Entries</div>
    </div>
</div>

<!-- New Entry Card -->
<div class="card mb-8">
    <div class="card-header">
        <h3 class="card-title">✍️ New Journal Entry</h3>
    </div>
    <div class="card-content">
        <form id="entryForm">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" 
                           class="form-input" 
                           id="entryTitle" 
                           placeholder="What's on your mind?">
                </div>
                <div class="form-group">
                    <label class="form-label">Mood</label>
                    <select class="form-input" id="entryMood">
                        <option value="">Select mood</option>
                        <option value="positive">😊 Positive</option>
                        <option value="neutral">😐 Neutral</option>
                        <option value="negative">😔 Negative</option>
                        <option value="excited">🤩 Excited</option>
                        <option value="calm">😌 Calm</option>
                        <option value="stressed">😰 Stressed</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Content</label>
                <textarea class="form-input" 
                          id="entryContent" 
                          rows="6" 
                          placeholder="Write your thoughts here..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Tags (comma-separated)</label>
                <input type="text" 
                       class="form-input" 
                       id="entryTags" 
                       placeholder="work, personal, reflection">
            </div>
            <div class="flex gap-4">
                <button type="submit" class="btn btn-primary">
                    📝 Save Entry
                    <span id="saveLoader" class="loading" style="display: none;"></span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearForm()">
                    🗑️ Clear
                </button>
            </div>
        </form>
        <div id="entryResult" class="mt-4"></div>
    </div>
</div>

<!-- Entries List -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">📚 Recent Entries</h3>
        <div class="flex gap-2">
            <input type="text" 
                   class="form-input" 
                   id="searchEntries" 
                   placeholder="Search entries..."
                   style="width: 200px;">
            <select class="form-input" id="filterMood" style="width: 150px;">
                <option value="">All Moods</option>
                <option value="positive">Positive</option>
                <option value="neutral">Neutral</option>
                <option value="negative">Negative</option>
                <option value="excited">Excited</option>
                <option value="calm">Calm</option>
                <option value="stressed">Stressed</option>
            </select>
        </div>
    </div>
    <div class="card-content">
        <div id="entriesList" class="space-y-4">
            {% for entry in entries|default([]) %}
            <div class="entry-item border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="font-semibold text-lg text-gray-900">{{ entry.title|default('Untitled Entry') }}</h4>
                        <div class="flex items-center gap-4 text-sm text-gray-500 mt-1">
                            <span>📅 {{ entry.created_at|default('Unknown date') }}</span>
                            {% if entry.mood %}
                            <span class="badge badge-{% if entry.mood == 'positive' %}success{% elif entry.mood == 'negative' %}danger{% else %}info{% endif %}">
                                {% if entry.mood == 'positive' %}😊{% elif entry.mood == 'negative' %}😔{% elif entry.mood == 'excited' %}🤩{% elif entry.mood == 'calm' %}😌{% elif entry.mood == 'stressed' %}😰{% else %}😐{% endif %}
                                {{ entry.mood|title }}
                            </span>
                            {% endif %}
                            <span>📝 {{ entry.word_count|default(0) }} words</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary btn-sm" onclick="editEntry({{ entry.id }})">
                            ✏️ Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteEntry({{ entry.id }})">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
                <div class="entry-content text-gray-700 mb-3">
                    <p>{{ (entry.content|default('No content'))[0:200] }}{% if (entry.content|default('')|length > 200) %}...{% endif %}</p>
                </div>
                {% if entry.tags %}
                <div class="entry-tags">
                    {% for tag in (entry.tags|default('')).split(',') %}
                    {% if tag.strip() %}
                    <span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full mr-2 mb-1">
                        #{{ tag.strip() }}
                    </span>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="text-center py-12 text-gray-500">
                <div class="text-6xl mb-4">📔</div>
                <h3 class="text-xl font-semibold mb-2">No journal entries yet</h3>
                <p>Start writing your first entry to capture your thoughts</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Edit Entry Modal -->
<div id="editEntryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">✏️ Edit Journal Entry</h3>
            <button class="modal-close" onclick="closeEditModal()">✕</button>
        </div>
        <div class="modal-body">
            <form id="editEntryForm">
                <input type="hidden" id="editEntryId">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" id="editEntryTitle" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mood</label>
                        <select id="editEntryMood" class="form-input">
                            <option value="">Select mood</option>
                            <option value="positive">😊 Positive</option>
                            <option value="neutral">😐 Neutral</option>
                            <option value="negative">😔 Negative</option>
                            <option value="excited">🤩 Excited</option>
                            <option value="calm">😌 Calm</option>
                            <option value="stressed">😰 Stressed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea id="editEntryContent" class="form-input" rows="8" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <input type="text" id="editEntryTags" class="form-input">
                </div>
                <div class="flex gap-3">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary flex-1">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.entry-item {
    transition: all 0.2s ease;
}

.entry-item:hover {
    transform: translateY(-1px);
}

.space-y-4 > * + * {
    margin-top: 1rem;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: var(--radius-lg);
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-6);
    border-bottom: 1px solid var(--color-gray-200);
}

.modal-close {
    background: none;
    border: none;
    font-size: var(--font-size-xl);
    cursor: pointer;
    color: var(--text-tertiary);
}

.modal-body {
    padding: var(--space-6);
}

.result-success {
    padding: var(--space-4);
    background: #dcfce7;
    border: 1px solid #16a34a;
    border-radius: var(--radius-md);
    color: #166534;
    font-size: var(--font-size-sm);
}

.result-error {
    padding: var(--space-4);
    background: #fee2e2;
    border: 1px solid #ef4444;
    border-radius: var(--radius-md);
    color: #991b1b;
    font-size: var(--font-size-sm);
}
</style>

<script>
// Add new entry
document.getElementById('entryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const title = document.getElementById('entryTitle').value.trim();
    const mood = document.getElementById('entryMood').value;
    const content = document.getElementById('entryContent').value.trim();
    const tags = document.getElementById('entryTags').value.trim();
    const loader = document.getElementById('saveLoader');
    
    if (!title || !content) {
        showResult('entryResult', 'Title and content are required', 'error');
        return;
    }
    
    loader.style.display = 'inline-block';
    
    const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
    
    fetch('/add-item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            table: 'journal_entries',
            data: {
                title: title,
                content: content,
                mood: mood,
                tags: tags,
                word_count: wordCount,
                created_at: new Date().toISOString()
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        loader.style.display = 'none';
        
        if (data.success) {
            showResult('entryResult', '✅ Journal entry saved successfully!', 'success');
            clearForm();
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showResult('entryResult', '❌ Failed to save entry', 'error');
        }
    })
    .catch(error => {
        loader.style.display = 'none';
        showResult('entryResult', '❌ Connection error. Please try again.', 'error');
        console.error('Error:', error);
    });
});

function clearForm() {
    document.getElementById('entryTitle').value = '';
    document.getElementById('entryMood').value = '';
    document.getElementById('entryContent').value = '';
    document.getElementById('entryTags').value = '';
}

function editEntry(entryId) {
    fetch(`/get-item?table=journal_entries&id=${entryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.item) {
                const entry = data.item;
                
                document.getElementById('editEntryId').value = entryId;
                document.getElementById('editEntryTitle').value = entry.title || '';
                document.getElementById('editEntryMood').value = entry.mood || '';
                document.getElementById('editEntryContent').value = entry.content || '';
                document.getElementById('editEntryTags').value = entry.tags || '';
                
                document.getElementById('editEntryModal').style.display = 'flex';
            } else {
                alert('Failed to load entry data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading entry data');
        });
}

function closeEditModal() {
    document.getElementById('editEntryModal').style.display = 'none';
}

function deleteEntry(entryId) {
    if (confirm('Are you sure you want to delete this journal entry? This action cannot be undone.')) {
        fetch('/delete-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table: 'journal_entries',
                id: entryId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete entry');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting entry');
        });
    }
}

function showResult(elementId, message, type) {
    const element = document.getElementById(elementId);
    element.innerHTML = `<div class="result-${type}">${message}</div>`;
    
    setTimeout(() => {
        element.innerHTML = '';
    }, 5000);
}

// Handle edit form submission
document.getElementById('editEntryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const entryId = document.getElementById('editEntryId').value;
    const title = document.getElementById('editEntryTitle').value.trim();
    const mood = document.getElementById('editEntryMood').value;
    const content = document.getElementById('editEntryContent').value.trim();
    const tags = document.getElementById('editEntryTags').value.trim();
    
    if (!title || !content) {
        alert('Title and content are required');
        return;
    }
    
    const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
    
    fetch('/edit-item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            table: 'journal_entries',
            id: parseInt(entryId),
            data: {
                title: title,
                mood: mood,
                content: content,
                tags: tags,
                word_count: wordCount
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEditModal();
            location.reload();
        } else {
            alert('Failed to update entry');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating entry');
    });
});

// Search and filter functionality
document.getElementById('searchEntries').addEventListener('input', filterEntries);
document.getElementById('filterMood').addEventListener('change', filterEntries);

function filterEntries() {
    const searchTerm = document.getElementById('searchEntries').value.toLowerCase();
    const moodFilter = document.getElementById('filterMood').value;
    const entries = document.querySelectorAll('.entry-item');
    
    entries.forEach(entry => {
        const title = entry.querySelector('h4').textContent.toLowerCase();
        const content = entry.querySelector('.entry-content').textContent.toLowerCase();
        const mood = entry.querySelector('.badge') ? entry.querySelector('.badge').textContent.toLowerCase() : '';
        
        const matchesSearch = title.includes(searchTerm) || content.includes(searchTerm);
        const matchesMood = !moodFilter || mood.includes(moodFilter);
        
        entry.style.display = (matchesSearch && matchesMood) ? 'block' : 'none';
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const editModal = document.getElementById('editEntryModal');
    
    if (event.target === editModal) {
        closeEditModal();
    }
}
</script>
{% endblock %}
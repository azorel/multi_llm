{% extends "base_modern.html" %}

{% block title %}Dashboard - LifeOS{% endblock %}
{% block header_title %}Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Welcome to LifeOS</h1>
    <p class="page-subtitle">Your intelligent automation and knowledge management system</p>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-4 mb-8">
    <div class="stat-card">
        <div class="stat-value" id="totalTasks">24</div>
        <div class="stat-label">Active Tasks</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="knowledgeItems">156</div>
        <div class="stat-label">Knowledge Items</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="agentActions">89</div>
        <div class="stat-label">Agent Actions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="completionRate">94%</div>
        <div class="stat-label">Completion Rate</div>
    </div>
</div>

<!-- Main Dashboard Grid -->
<div class="grid grid-cols-3 gap-6">
    <!-- GitHub Repository Processor -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">📦 GitHub Repository Import</h3>
        </div>
        <div class="card-content">
            <div class="form-group">
                <label class="form-label">Repository URL</label>
                <input type="text" 
                       class="form-input" 
                       id="githubRepoUrl" 
                       placeholder="https://github.com/owner/repo">
            </div>
            <button class="btn btn-primary w-full" onclick="processGitHubRepo()">
                <span id="githubBtnText">Import Repository</span>
                <span id="githubLoader" class="loading" style="display: none;"></span>
            </button>
            <div id="githubResult" class="mt-4"></div>
        </div>
    </div>
    
    <!-- YouTube Processor -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">📺 YouTube Processor</h3>
        </div>
        <div class="card-content">
            <div class="form-group">
                <label class="form-label">YouTube URL</label>
                <input type="text" 
                       class="form-input" 
                       id="youtubeUrl" 
                       placeholder="https://youtube.com/watch?v=...">
            </div>
            <button class="btn btn-primary w-full" onclick="processYouTubeVideo()">
                <span id="youtubeBtnText">Process Video</span>
                <span id="youtubeLoader" class="loading" style="display: none;"></span>
            </button>
            <div id="youtubeResult" class="mt-4"></div>
        </div>
    </div>
    
    <!-- Quick Commands -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">⚡ Quick Commands</h3>
        </div>
        <div class="card-content">
            <div class="form-group">
                <label class="form-label">Command</label>
                <input type="text" 
                       class="form-input" 
                       id="quickCommand" 
                       placeholder="Enter command...">
            </div>
            <button class="btn btn-success w-full" onclick="executeQuickCommand()">
                Execute Command
            </button>
            <div class="mt-4 space-y-2">
                <button class="btn btn-secondary btn-sm w-full" onclick="runPresetCommand('analyze-system')">
                    🔍 Analyze System
                </button>
                <button class="btn btn-secondary btn-sm w-full" onclick="runPresetCommand('backup-data')">
                    💾 Backup Data
                </button>
                <button class="btn btn-secondary btn-sm w-full" onclick="runPresetCommand('optimize-performance')">
                    ⚡ Optimize Performance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- New Agent & Analysis Features -->
<div class="grid grid-cols-5 gap-6 mt-8">
    <!-- Agent Task Interface -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">🎯 Agent Tasks</h3>
        </div>
        <div class="card-content">
            <p class="text-sm text-gray-600 mb-3">Submit custom tasks to your autonomous agents</p>
            <a href="/agent-task-interface" class="btn btn-primary w-full">
                🤖 Open Agent Interface
            </a>
        </div>
    </div>
    
    <!-- Code Analysis -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">🔍 Code Analysis</h3>
        </div>
        <div class="card-content">
            <p class="text-sm text-gray-600 mb-3">Analyze repository code and patterns</p>
            <a href="/code-analysis" class="btn btn-primary w-full">
                📊 Open Code Analysis
            </a>
        </div>
    </div>
    
    <!-- Performance Analytics -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">📈 Analytics</h3>
        </div>
        <div class="card-content">
            <p class="text-sm text-gray-600 mb-3">Monitor agent performance and metrics</p>
            <a href="/analytics-dashboard" class="btn btn-primary w-full">
                📊 View Analytics
            </a>
        </div>
    </div>
    
    <!-- Automation Pipeline -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">🤖 Automation</h3>
        </div>
        <div class="card-content">
            <p class="text-sm text-gray-600 mb-3">Control GitHub processing automation</p>
            <a href="/automation" class="btn btn-primary w-full">
                ⚙️ Open Automation
            </a>
        </div>
    </div>
    
    <!-- TDD System -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">🧪 TDD System</h3>
        </div>
        <div class="card-content">
            <p class="text-sm text-gray-600 mb-3">Test-Driven Development with AI</p>
            <a href="/tdd-dashboard" class="btn btn-primary w-full">
                🔄 Open TDD Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Agent Activity Feed -->
<div class="card mt-8">
    <div class="card-header flex justify-between items-center">
        <h3 class="card-title">🤖 Agent Activity Feed</h3>
        <div class="flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="pauseAllAgents()">
                ⏸️ Pause All
            </button>
            <button class="btn btn-primary btn-sm" onclick="refreshActivity()">
                🔄 Refresh
            </button>
        </div>
    </div>
    <div class="card-content">
        <div id="activityFeed" class="space-y-4">
            <!-- Activity items will be populated here -->
        </div>
    </div>
</div>

<!-- Recent Repositories and Channels -->
<div class="grid grid-cols-2 gap-6 mt-8">
    <!-- Recent GitHub Repositories -->
    <div class="card">
        <div class="card-header flex justify-between items-center">
            <h3 class="card-title">📦 Recent Repositories</h3>
            <a href="/github-repos" class="btn btn-secondary btn-sm">View All</a>
        </div>
        <div class="card-content">
            <div id="recentRepos" class="space-y-3">
                <!-- Repository items will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Recent YouTube Channels -->
    <div class="card">
        <div class="card-header flex justify-between items-center">
            <h3 class="card-title">📺 Recent Channels</h3>
            <a href="/youtube-channels" class="btn btn-secondary btn-sm">View All</a>
        </div>
        <div class="card-content">
            <div id="recentChannels" class="space-y-3">
                <!-- Channel items will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- System Performance -->
<div class="card mt-8">
    <div class="card-header">
        <h3 class="card-title">📊 System Performance</h3>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-4 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600" id="cpuUsage">23%</div>
                <div class="text-sm text-gray-500">CPU Usage</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600" id="memoryUsage">67%</div>
                <div class="text-sm text-gray-500">Memory Usage</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600" id="apiCalls">1,234</div>
                <div class="text-sm text-gray-500">API Calls Today</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-orange-600" id="totalCost">$12.45</div>
                <div class="text-sm text-gray-500">Cost Today</div>
            </div>
        </div>
    </div>
</div>

<style>
/* Additional custom styles for this page */
.w-full { width: 100%; }
.space-y-2 > * + * { margin-top: 0.5rem; }
.space-y-3 > * + * { margin-top: 0.75rem; }
.space-y-4 > * + * { margin-top: 1rem; }

.result-success {
    padding: 1rem;
    background: #dcfce7;
    border: 1px solid #16a34a;
    border-radius: 0.5rem;
    color: #166534;
    font-size: 0.875rem;
}

.result-error {
    padding: 1rem;
    background: #fee2e2;
    border: 1px solid #ef4444;
    border-radius: 0.5rem;
    color: #991b1b;
    font-size: 0.875rem;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--color-gray-50);
    border-radius: 0.5rem;
    border-left: 4px solid var(--color-primary);
}

.activity-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    font-size: 1.2rem;
}

.activity-content {
    flex: 1;
}

.activity-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.activity-time {
    font-size: 0.75rem;
    color: var(--text-tertiary);
}

.repo-item, .channel-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    background: var(--color-gray-50);
    border-radius: 0.5rem;
    transition: all 0.2s ease;
}

.repo-item:hover, .channel-item:hover {
    background: var(--color-gray-100);
}

.repo-info, .channel-info {
    flex: 1;
}

.repo-name, .channel-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.repo-stats, .channel-stats {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-top: 0.25rem;
}
</style>

<script>
// GitHub Repository Processing
function processGitHubRepo() {
    const url = document.getElementById('githubRepoUrl').value.trim();
    const result = document.getElementById('githubResult');
    const btnText = document.getElementById('githubBtnText');
    const loader = document.getElementById('githubLoader');
    
    if (!url) {
        showResult('githubResult', 'Please enter a repository URL', 'error');
        return;
    }
    
    if (!url.includes('github.com')) {
        showResult('githubResult', 'Please enter a valid GitHub repository URL', 'error');
        return;
    }
    
    // Show loading state
    btnText.style.display = 'none';
    loader.style.display = 'inline-block';
    
    fetch('/add-github-repo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            repo_url: url
        })
    })
    .then(response => response.json())
    .then(data => {
        btnText.style.display = 'inline';
        loader.style.display = 'none';
        
        if (data.success) {
            showResult('githubResult', `✅ Successfully imported ${url.split('/').slice(-2).join('/')} (${data.stars || 0} stars)`, 'success');
            document.getElementById('githubRepoUrl').value = '';
            addActivityItem('📦', 'GitHub repository imported successfully', 'just now');
            loadRecentRepos();
        } else {
            showResult('githubResult', `❌ Failed to import: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        btnText.style.display = 'inline';
        loader.style.display = 'none';
        showResult('githubResult', '❌ Connection error. Please try again.', 'error');
        console.error('Error:', error);
    });
}

// YouTube Video Processing
function processYouTubeVideo() {
    const url = document.getElementById('youtubeUrl').value.trim();
    const btnText = document.getElementById('youtubeBtnText');
    const loader = document.getElementById('youtubeLoader');
    
    if (!url) {
        showResult('youtubeResult', 'Please enter a YouTube URL', 'error');
        return;
    }
    
    // Show loading state
    btnText.style.display = 'none';
    loader.style.display = 'inline-block';
    
    // Simulate processing
    setTimeout(() => {
        btnText.style.display = 'inline';
        loader.style.display = 'none';
        showResult('youtubeResult', '✅ Video transcript processed successfully', 'success');
        document.getElementById('youtubeUrl').value = '';
        addActivityItem('📺', 'YouTube video processed successfully', 'just now');
    }, 2000);
}

// Quick Command Execution
function executeQuickCommand() {
    const command = document.getElementById('quickCommand').value.trim();
    if (command) {
        addActivityItem('⚡', `Executed: ${command}`, 'just now');
        document.getElementById('quickCommand').value = '';
    }
}

function runPresetCommand(command) {
    const commandMap = {
        'analyze-system': 'System analysis initiated',
        'backup-data': 'Data backup started',
        'optimize-performance': 'Performance optimization running'
    };
    
    addActivityItem('🔧', commandMap[command] || 'Command executed', 'just now');
}

// Utility Functions
function showResult(elementId, message, type) {
    const element = document.getElementById(elementId);
    element.innerHTML = `<div class="result-${type}">${message}</div>`;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        element.innerHTML = '';
    }, 5000);
}

function addActivityItem(icon, title, time) {
    const feed = document.getElementById('activityFeed');
    const item = document.createElement('div');
    item.className = 'activity-item';
    item.innerHTML = `
        <div class="activity-icon">${icon}</div>
        <div class="activity-content">
            <div class="activity-title">${title}</div>
            <div class="activity-time">${time}</div>
        </div>
    `;
    feed.insertBefore(item, feed.firstChild);
    
    // Keep only the latest 10 items
    while (feed.children.length > 10) {
        feed.removeChild(feed.lastChild);
    }
}

// Load recent repositories
function loadRecentRepos() {
    fetch('/api/recent-repos')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('recentRepos');
                container.innerHTML = data.repos.map(repo => `
                    <div class="repo-item">
                        <div class="repo-info">
                            <div class="repo-name">${repo.name}</div>
                            <div class="repo-stats">⭐ ${repo.stars} • 🍴 ${repo.forks} • ${repo.language}</div>
                        </div>
                        <a href="${repo.url}" target="_blank" class="btn btn-secondary btn-sm">View</a>
                    </div>
                `).join('');
            }
        })
        .catch(error => {
            // Fallback with static data
            loadStaticRepos();
        });
}

function loadStaticRepos() {
    const staticRepos = [
        { name: 'microsoft/vscode', stars: '173K', forks: '33K', language: 'TypeScript', url: 'https://github.com/microsoft/vscode' },
        { name: 'torvalds/linux', stars: '195K', forks: '56K', language: 'C', url: 'https://github.com/torvalds/linux' }
    ];
    
    const container = document.getElementById('recentRepos');
    container.innerHTML = staticRepos.map(repo => `
        <div class="repo-item">
            <div class="repo-info">
                <div class="repo-name">${repo.name}</div>
                <div class="repo-stats">⭐ ${repo.stars} • 🍴 ${repo.forks} • ${repo.language}</div>
            </div>
            <a href="${repo.url}" target="_blank" class="btn btn-secondary btn-sm">View</a>
        </div>
    `).join('');
}

// Load recent channels
function loadRecentChannels() {
    const staticChannels = [
        { name: 'Fireship', subscribers: '2.8M', videos: '400+', url: 'https://youtube.com/@Fireship' },
        { name: 'ThePrimeagen', subscribers: '500K', videos: '800+', url: 'https://youtube.com/@ThePrimeagen' }
    ];
    
    const container = document.getElementById('recentChannels');
    container.innerHTML = staticChannels.map(channel => `
        <div class="channel-item">
            <div class="channel-info">
                <div class="channel-name">${channel.name}</div>
                <div class="channel-stats">👥 ${channel.subscribers} • 📺 ${channel.videos}</div>
            </div>
            <a href="${channel.url}" target="_blank" class="btn btn-secondary btn-sm">View</a>
        </div>
    `).join('');
}

// System performance simulation
function updateSystemStats() {
    document.getElementById('cpuUsage').textContent = Math.floor(Math.random() * 40 + 10) + '%';
    document.getElementById('memoryUsage').textContent = Math.floor(Math.random() * 30 + 50) + '%';
    document.getElementById('apiCalls').textContent = (Math.floor(Math.random() * 500 + 1000)).toLocaleString();
    document.getElementById('totalCost').textContent = '$' + (Math.random() * 20 + 5).toFixed(2);
}

// Agent controls
function pauseAllAgents() {
    addActivityItem('⏸️', 'All agents paused', 'just now');
}

function refreshActivity() {
    addActivityItem('🔄', 'Activity feed refreshed', 'just now');
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadStaticRepos();
    loadRecentChannels();
    
    // Add some initial activity
    addActivityItem('🚀', 'System initialized successfully', '5 minutes ago');
    addActivityItem('🤖', 'Agent orchestrator started', '3 minutes ago');
    addActivityItem('✅', 'All systems operational', '1 minute ago');
    
    // Update system stats every 30 seconds
    updateSystemStats();
    setInterval(updateSystemStats, 30000);
    
    // Handle Enter key for inputs
    document.getElementById('githubRepoUrl').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') processGitHubRepo();
    });
    
    document.getElementById('youtubeUrl').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') processYouTubeVideo();
    });
    
    document.getElementById('quickCommand').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') executeQuickCommand();
    });
});
</script>
{% endblock %}
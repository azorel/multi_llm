{% extends "base.html" %}

{% block title %}Revenue Analytics - LifeOS{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">💰 Revenue Analytics</h1>
    <p class="page-subtitle">
        Real-time revenue tracking and analytics for all business ventures.
        <span style="float: right; color: var(--notion-text-light); font-size: 12px;">
            Total Revenue: ${{ "{:,}".format(revenue_data.total_revenue or 0) }}
            <button onclick="location.reload()" style="margin-left: 8px; background: var(--notion-blue); color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 11px; cursor: pointer;">
                🔄 Refresh
            </button>
        </span>
    </p>
</div>

<!-- Revenue Summary Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 32px;">
    <div class="notion-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
        <div class="card-title" style="color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">💰 Total Revenue</div>
        <div class="card-content" style="color: white;">
            <div style="font-size: 36px; font-weight: 600;">${{ "{:,}".format(revenue_data.total_revenue or 0) }}</div>
            <div style="font-size: 14px; opacity: 0.9;">All time earnings</div>
        </div>
    </div>
    
    <div class="notion-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
        <div class="card-title" style="color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">📅 Monthly Revenue</div>
        <div class="card-content" style="color: white;">
            <div style="font-size: 36px; font-weight: 600;">${{ "{:,}".format(revenue_data.monthly_revenue or 0) }}</div>
            <div style="font-size: 14px; opacity: 0.9;">This month</div>
        </div>
    </div>
    
    <div class="notion-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
        <div class="card-title" style="color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">📈 Monthly Growth</div>
        <div class="card-content" style="color: white;">
            <div style="font-size: 36px; font-weight: 600;">{{ revenue_data.growth_metrics.monthly_growth or 0 }}%</div>
            <div style="font-size: 14px; opacity: 0.9;">vs last month</div>
        </div>
    </div>
    
    <div class="notion-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
        <div class="card-title" style="color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">🎯 Active Streams</div>
        <div class="card-content" style="color: white;">
            <div style="font-size: 36px; font-weight: 600;">{{ revenue_data.revenue_streams|length }}</div>
            <div style="font-size: 14px; opacity: 0.9;">Revenue sources</div>
        </div>
    </div>
</div>

<!-- Revenue by Category -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
    <div class="notion-card">
        <div class="card-title">📊 Revenue by Category</div>
        <div class="card-content">
            {% if revenue_data.revenue_by_category %}
                <div style="margin-bottom: 16px;">
                    <canvas id="categoryChart" width="400" height="300"></canvas>
                </div>
                {% for category in revenue_data.revenue_by_category %}
                <div style="display: flex; justify-content: between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="category-dot category-{{ category.category.lower().replace(' ', '-') }}"></div>
                        <span style="font-weight: 600;">{{ category.category }}</span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--notion-green);">${{ "{:,}".format(category.revenue or 0) }}</div>
                        <div style="font-size: 12px; color: var(--notion-text-light);">{{ category.streams }} streams</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 40px; color: var(--notion-text-light);">
                    <p>No revenue data available yet</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">📈 Growth Metrics</div>
        <div class="card-content">
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                    <span>Monthly Growth</span>
                    <span style="font-weight: 600; color: var(--notion-green);">{{ revenue_data.growth_metrics.monthly_growth or 0 }}%</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" style="width: {{ (revenue_data.growth_metrics.monthly_growth or 0) / 2 }}%;"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                    <span>Yearly Growth</span>
                    <span style="font-weight: 600; color: var(--notion-blue);">{{ revenue_data.growth_metrics.yearly_growth or 0 }}%</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" style="width: {{ (revenue_data.growth_metrics.yearly_growth or 0) / 4 }}%; background: var(--notion-blue);"></div>
                </div>
            </div>
            
            <div style="padding: 16px; background: #f8fafc; border-radius: 8px;">
                <h4 style="margin: 0 0 8px 0; color: var(--notion-text);">Revenue Targets</h4>
                <div style="font-size: 12px; color: var(--notion-text-light);">
                    Next Month: ${{ "{:,}".format((revenue_data.monthly_revenue or 0) * 1.2) }}<br>
                    This Year: ${{ "{:,}".format((revenue_data.monthly_revenue or 0) * 12 * 1.8) }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Revenue Streams Table -->
<div class="database-container">
    <div class="database-header">
        <span class="database-title">💸 Active Revenue Streams ({{ revenue_data.revenue_streams|length }})</span>
        <button onclick="addRevenueStream()" class="add-button">➕ Add Stream</button>
    </div>
    
    {% if revenue_data.revenue_streams %}
    <table class="database-table">
        <thead>
            <tr>
                <th>Stream Name</th>
                <th>Project</th>
                <th>Category</th>
                <th>Revenue</th>
                <th>Frequency</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for stream in revenue_data.revenue_streams %}
            <tr class="revenue-row category-{{ stream.category.lower().replace(' ', '-') }}">
                <td>
                    <div style="font-weight: 600; margin-bottom: 4px;">{{ stream.stream_name }}</div>
                </td>
                <td style="font-size: 14px;">{{ stream.project_name }}</td>
                <td>
                    <span class="status-pill category-{{ stream.category.lower().replace(' ', '-') }}">
                        {{ stream.category }}
                    </span>
                </td>
                <td style="font-size: 16px; font-weight: 600; color: var(--notion-green);">
                    ${{ "{:,}".format(stream.amount or 0) }}
                </td>
                <td style="font-size: 14px;">{{ stream.frequency }}</td>
                <td>
                    {% if stream.status == 'active' %}
                        <span class="status-pill status-active">✅ Active</span>
                    {% elif stream.status == 'paused' %}
                        <span class="status-pill status-paused">⏸️ Paused</span>
                    {% else %}
                        <span class="status-pill status-default">{{ stream.status.title() }}</span>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 4px;">
                        <button onclick="editStream('{{ stream.stream_name }}')" 
                                style="background: var(--notion-blue); color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">
                            ✏️ Edit
                        </button>
                        <button onclick="pauseStream('{{ stream.stream_name }}')" 
                                style="background: var(--notion-orange); color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">
                            ⏸️ Pause
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 40px; text-align: center; color: var(--notion-text-light);">
        <h3>No revenue streams found</h3>
        <p>Revenue streams will be automatically created when projects start generating income.</p>
        <button onclick="addRevenueStream()" class="add-button" style="margin-top: 16px;">
            💸 Add Manual Stream
        </button>
    </div>
    {% endif %}
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Revenue by Category Chart
{% if revenue_data.revenue_by_category %}
const ctx = document.getElementById('categoryChart').getContext('2d');
const categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: [
            {% for category in revenue_data.revenue_by_category %}
            '{{ category.category }}',
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for category in revenue_data.revenue_by_category %}
                {{ category.revenue or 0 }},
                {% endfor %}
            ],
            backgroundColor: [
                '#dc3545', '#28a745', '#007bff', '#ffc107', '#6c757d', '#17a2b8'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}

function addRevenueStream() {
    const streamName = prompt('Revenue stream name:');
    if (!streamName) return;
    
    const amount = prompt('Monthly amount ($):', '1000');
    const frequency = prompt('Frequency (monthly/weekly/one-time):', 'monthly');
    
    if (streamName && amount && frequency) {
        alert('Manual revenue stream creation coming soon!');
    }
}

function editStream(streamName) {
    alert('Edit revenue stream coming soon! Stream: ' + streamName);
}

function pauseStream(streamName) {
    if (confirm('Pause this revenue stream?')) {
        alert('Pause revenue stream coming soon! Stream: ' + streamName);
    }
}
</script>

<style>
.revenue-row {
    transition: all 0.2s ease;
}

.revenue-row:hover {
    background: rgba(0, 0, 0, 0.02);
}

.category-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.category-dot.category-rc { background: #dc3545; }
.category-dot.category-van-life { background: #28a745; }
.category-dot.category-3d-printing { background: #007bff; }
.category-dot.category-general { background: #ffc107; }

.category-rc { border-left: 4px solid #dc3545; }
.category-van-life { border-left: 4px solid #28a745; }
.category-3d-printing { border-left: 4px solid #007bff; }
.category-general { border-left: 4px solid #ffc107; }

.status-pill.category-rc { background: #fee2e2; color: #dc2626; }
.status-pill.category-van-life { background: #dcfce7; color: #16a34a; }
.status-pill.category-3d-printing { background: #dbeafe; color: #2563eb; }
.status-pill.category-general { background: #fef3c7; color: #d97706; }

.status-active { background: #dcfce7; color: #16a34a; }
.status-paused { background: #fef3c7; color: #d97706; }
.status-default { background: #f3f4f6; color: #6b7280; }

.progress-container {
    width: 100%;
    height: 8px;
    background: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: var(--notion-green);
    border-radius: 4px;
    transition: width 0.3s ease;
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}Maintenance Schedule - LifeOS{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üîß Maintenance Schedule</h1>
    <p class="page-subtitle">
        Track maintenance tasks for RC cars, equipment, and regular upkeep items.
    </p>
</div>

<div class="database-container">
    <div class="database-header">
        <span class="database-title">Maintenance Items ({{ items|length if items else 0 }} items)</span>
        <button class="add-button" onclick="addNewItem()">+ Add Item</button>
    </div>
    
    {% if items and items|length > 0 %}
    <table class="database-table">
        <thead>
            <tr>
                <th style="width: 40px;">‚úì</th>
                <th>Item Name</th>
                <th>Category</th>
                <th>Last Maintenance</th>
                <th>Next Due</th>
                <th>Frequency</th>
                <th>Status</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            {% set is_overdue = item.next_due and item.next_due < today %}
            <tr class="{% if item.completed %}completed{% elif is_overdue %}overdue{% endif %}">
                <td>
                    <input type="checkbox" 
                           class="notion-checkbox" 
                           {% if item.completed %}checked{% endif %}
                           data-table="maintenance_schedule" 
                           data-id="{{ item.id }}" 
                           data-field="completed">
                </td>
                <td style="font-weight: 600;">{{ item.item_name or 'Unnamed Item' }}</td>
                <td>
                    <span class="status-pill status-{{ (item.category or 'general').lower() }}">
                        {{ item.category or 'General' }}
                    </span>
                </td>
                <td style="color: var(--notion-text-light); font-size: 14px;">{{ item.last_maintenance or 'Never' }}</td>
                <td style="{% if is_overdue %}color: var(--notion-red); font-weight: 600;{% else %}color: var(--notion-text-light);{% endif %} font-size: 14px;">
                    {{ item.next_due or 'Not set' }}
                    {% if is_overdue %} (OVERDUE){% endif %}
                </td>
                <td style="color: var(--notion-blue);">{{ item.frequency_days or 30 }} days</td>
                <td>
                    {% if item.completed %}
                        <span class="status-pill status-completed">‚úÖ Done</span>
                    {% elif is_overdue %}
                        <span class="status-pill status-error">‚ö†Ô∏è Overdue</span>
                    {% else %}
                        <span class="status-pill status-pending">üìÖ Scheduled</span>
                    {% endif %}
                </td>
                <td style="color: var(--notion-text-light); font-size: 12px;">{{ (item.notes or '')[:50] }}{% if item.notes and item.notes|length > 50 %}...{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 40px; text-align: center; color: var(--notion-text-light);">
        <p>No maintenance items scheduled. Add your RC cars, equipment, and regular maintenance tasks!</p>
    </div>
    {% endif %}
</div>

<!-- Maintenance Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 32px;">
    <div class="notion-card">
        <div class="card-title">üìä Maintenance Overview</div>
        <div class="card-content">
            {% if items and items|length > 0 %}
                {% set completed = items | selectattr('completed', 'equalto', True) | list %}
                {% set overdue = items | selectattr('next_due', 'lessthan', today) | selectattr('completed', 'equalto', False) | list %}
                Total Items: {{ items|length }}<br>
                Completed: {{ completed|length }}<br>
                Overdue: {{ overdue|length }}
            {% else %}
                No maintenance data
            {% endif %}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">üèÅ RC Car Focus</div>
        <div class="card-content">
            {% if items and items|length > 0 %}
                {% set rc_items = items | selectattr('category', 'match', '.*[Rr][Cc].*') | list %}
                {% set rc_completed = rc_items | selectattr('completed', 'equalto', True) | list %}
                RC Items: {{ rc_items|length }}<br>
                RC Complete: {{ rc_completed|length }}<br>
                RC Pending: {{ rc_items|length - rc_completed|length }}
            {% else %}
                No RC maintenance yet
            {% endif %}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">üìÖ Upcoming Tasks</div>
        <div class="card-content">
            {% if items and items|length > 0 %}
                {% set next_week = (now + timedelta(days=7)).strftime('%Y-%m-%d') %}
                {% set upcoming = items | selectattr('next_due', 'lessthan', next_week) | selectattr('completed', 'equalto', False) | list %}
                Next 7 days: {{ upcoming|length }}<br>
                {% if upcoming %}
                    Next: {{ upcoming[0].item_name if upcoming[0] else 'None' }}
                {% else %}
                    Nothing urgent
                {% endif %}
            {% else %}
                No upcoming tasks
            {% endif %}
        </div>
    </div>
</div>

<script>
function addNewItem() {
    const itemName = prompt('Maintenance item name (e.g., "RC Car Oil Change"):');
    if (itemName) {
        const category = prompt('Category (RC Car, Equipment, General):', 'RC Car');
        const frequency = prompt('Frequency in days:', '30');
        const notes = prompt('Notes (optional):');
        
        fetch('/add-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table: 'maintenance_schedule',
                data: {
                    item_name: itemName,
                    category: category || 'General',
                    frequency_days: parseInt(frequency) || 30,
                    notes: notes || '',
                    completed: false,
                    next_due: new Date(Date.now() + (parseInt(frequency) || 30) * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to add maintenance item');
            }
        });
    }
}
</script>

<style>
.overdue {
    background-color: #ffeaea !important;
    border-left: 3px solid var(--notion-red) !important;
}
</style>
{% endblock %}
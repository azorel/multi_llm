{% extends "sql_base.html" %}

{% block title %}{{ video.title }} - Video Details{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">🎥 {{ video.title }}</h1>
    <p class="page-subtitle">
        {{ video.channel_name }} • {{ video.duration or 'Duration unknown' }} • {{ video.upload_date or 'Upload date unknown' }}
    </p>
</div>

<!-- Action Bar -->
<div style="margin-bottom: 24px;">
    <div style="display: flex; gap: 12px; align-items: center;">
        {% if video.youtube_url %}
        <a href="{{ video.youtube_url }}" target="_blank" class="notion-button primary">
            🎬 Watch on YouTube
        </a>
        {% endif %}
        <button onclick="processVideo({{ video.id }})" class="notion-button secondary">
            🤖 Re-process with AI
        </button>
        <a href="/knowledge_hub" class="notion-button secondary">
            ← Back to Knowledge Hub
        </a>
    </div>
</div>

<!-- Video Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px;">
    <div class="notion-card">
        <div class="card-title">📊 Status</div>
        <div class="card-content">
            <span class="status-pill status-{{ video.processing_status.lower() if video.processing_status else 'pending' }}">
                {{ video.processing_status or 'Pending' }}
            </span>
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">📺 Channel</div>
        <div class="card-content">
            {{ video.channel_name or 'Unknown Channel' }}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">⏱️ Duration</div>
        <div class="card-content">
            {{ video.duration or 'N/A' }}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">📅 Uploaded</div>
        <div class="card-content">
            {{ video.upload_date.split(' ')[0] if video.upload_date else 'N/A' }}
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">🔄 Processed</div>
        <div class="card-content">
            {{ video.processing_date.split(' ')[0] if video.processing_date else 'Not processed' }}
        </div>
    </div>
</div>

<!-- Video Description -->
{% if video.description %}
<div class="notion-card" style="margin-bottom: 32px;">
    <div class="card-title">📝 Description</div>
    <div class="card-content" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
{{ video.description }}
    </div>
</div>
{% endif %}

<!-- AI Analysis -->
{% if video.ai_summary or video.ai_insights or video.ai_key_points %}
<div class="notion-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 32px;">
    <div class="card-title" style="color: white;">🧠 AI Analysis</div>
    <div class="card-content">
        {% if video.ai_summary %}
        <div style="margin-bottom: 16px;">
            <h4 style="color: white; margin-bottom: 8px;">Summary</h4>
            <p style="line-height: 1.6;">{{ video.ai_summary }}</p>
        </div>
        {% endif %}
        
        {% if video.ai_key_points %}
        <div style="margin-bottom: 16px;">
            <h4 style="color: white; margin-bottom: 8px;">Key Points</h4>
            <div style="line-height: 1.6;">{{ video.ai_key_points }}</div>
        </div>
        {% endif %}
        
        {% if video.ai_insights %}
        <div>
            <h4 style="color: white; margin-bottom: 8px;">Insights</h4>
            <div style="line-height: 1.6;">{{ video.ai_insights }}</div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Video Transcript -->
{% if video.transcript %}
<div class="notion-card">
    <div class="card-title">📜 Full Transcript</div>
    <div class="card-content">
        <div style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 16px; border-radius: 6px; font-family: monospace; font-size: 14px; line-height: 1.5; white-space: pre-wrap;">{{ video.transcript }}</div>
    </div>
</div>
{% endif %}

<!-- Technical Details -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 32px;">
    <div class="notion-card">
        <div class="card-title">🔧 Technical Details</div>
        <div class="card-content">
            <table style="width: 100%; font-size: 14px;">
                <tr>
                    <td style="padding: 4px 0; font-weight: 600;">Video ID:</td>
                    <td style="padding: 4px 0;">{{ video.youtube_id or 'N/A' }}</td>
                </tr>
                <tr>
                    <td style="padding: 4px 0; font-weight: 600;">Database ID:</td>
                    <td style="padding: 4px 0;">{{ video.id }}</td>
                </tr>
                <tr>
                    <td style="padding: 4px 0; font-weight: 600;">Language:</td>
                    <td style="padding: 4px 0;">{{ video.language or 'Unknown' }}</td>
                </tr>
                <tr>
                    <td style="padding: 4px 0; font-weight: 600;">Created:</td>
                    <td style="padding: 4px 0;">{{ video.created_at or 'N/A' }}</td>
                </tr>
                <tr>
                    <td style="padding: 4px 0; font-weight: 600;">Updated:</td>
                    <td style="padding: 4px 0;">{{ video.updated_at or 'N/A' }}</td>
                </tr>
            </table>
        </div>
    </div>
    
    <div class="notion-card">
        <div class="card-title">⚙️ Processing Info</div>
        <div class="card-content">
            <table style="width: 100%; font-size: 14px;">
                <tr>
                    <td style="padding: 4px 0; font-weight: 600;">Status:</td>
                    <td style="padding: 4px 0;">
                        <span class="status-pill status-{{ video.processing_status.lower() if video.processing_status else 'pending' }}">
                            {{ video.processing_status or 'Pending' }}
                        </span>
                    </td>
                </tr>
                <tr>
                    <td style="padding: 4px 0; font-weight: 600;">Error Message:</td>
                    <td style="padding: 4px 0;">{{ video.error_message or 'None' }}</td>
                </tr>
                <tr>
                    <td style="padding: 4px 0; font-weight: 600;">Retry Count:</td>
                    <td style="padding: 4px 0;">{{ video.retry_count or '0' }}</td>
                </tr>
                <tr>
                    <td style="padding: 4px 0; font-weight: 600;">Agent:</td>
                    <td style="padding: 4px 0;">{{ video.processing_agent or 'Multi-Agent System' }}</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<script>
function processVideo(videoId) {
    if (confirm('Re-process this video with AI? This will update the analysis and insights.')) {
        fetch(`/api/process_video/${videoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Video queued for AI processing. Check back in a few minutes for updated analysis.');
                location.reload();
            } else {
                alert('Failed to queue video for processing: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
}
</script>
{% endblock %}